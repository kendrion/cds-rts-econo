
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1.5.10. Standard block drivers and their network addresses &#8212; RuntimeSystemOnlineHelp V3.5.14.0</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.5.14.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="RuntimeSystemOnlineHelp V3.5.14.0" href="../index.html" />
    <link rel="up" title="1.5. Communication" href="communication.html" />
    <link rel="next" title="1.5.11. Modules" href="comm_modules.html" />
    <link rel="prev" title="1.5.9. Implementation of Own Communication Driver" href="comm_implement_own_driver.html" /> 
  </head>
  <body role="document">
	<div id="header">
		<a href="#" title="CODESYS" target="_top" id="logo"><img src="../_static/logo.png" width="134" height="130" alt=""></a>
		<a href="#" title="CODESYS Documentation" target="_top" id="logo-store"><img src="../_static/logo2.png" width="137" height="130" alt=""></a>
	</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="comm_modules.html" title="1.5.11. Modules"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="comm_implement_own_driver.html" title="1.5.9. Implementation of Own Communication Driver"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RuntimeSystemOnlineHelp V3.5.14.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >1. CODESYS Control V3 - Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="communication.html" accesskey="U">1.5. Communication</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">1.5.10. Standard block drivers and their network addresses</a><ul>
<li><a class="reference internal" href="#overview">1.5.10.1. Overview</a></li>
<li><a class="reference internal" href="#udp-block-driver">1.5.10.2. UDP block driver</a></li>
<li><a class="reference internal" href="#serial-block-driver">1.5.10.3. Serial block driver</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="comm_implement_own_driver.html"
                        title="previous chapter">1.5.9. Implementation of Own Communication Driver</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="comm_modules.html"
                        title="next chapter">1.5.11. Modules</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Manual/comm_standard_block_drivers.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="standard-block-drivers-and-their-network-addresses">
<span id="comm-standard-block-drivers"></span><h1>1.5.10. Standard block drivers and their network addresses<a class="headerlink" href="#standard-block-drivers-and-their-network-addresses" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>1.5.10.1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This chapter uses an example to describe the formation of the network
address for network adapters based on different block drivers. For
formation of the node address from this network address please refer to
chapter 5.4.4 Address structure.</p>
</div>
<div class="section" id="udp-block-driver">
<h2>1.5.10.2. UDP block driver<a class="headerlink" href="#udp-block-driver" title="Permalink to this headline">¶</a></h2>
<p>The UDP block driver does not define physical network connections as
network connections, but uses each available IP address of a system as a
(virtual) network connection. For each such network connection the block
driver uses four predefined UDP ports. In the standard configuration
they are ports 1740, 1741, 1742 and 1743. The block driver uses
precisely one of these ports for sending and receiving data. It either
uses the port specified by the configuration or the first free port if
no port is configured. The remaining ports are available for further
runtime system instances on the same device. The block driver sends
broadcasts always to all four ports in the network.</p>
<p>The block driver operates on local network segments that have a common
IP network address. The network address is formed from the relevant bits
of the IP address (i.e. without the network mask) and the port index.</p>
<p>The diagram illustrates the address formation for the following
configuration:</p>
<ul class="simple">
<li>IP address <strong>172.17.69.104</strong> (= <strong>AC.11.45.68</strong> hexadecimal)</li>
<li><dl class="first docutils">
<dt>IP network mask <strong>255.255.248.0</strong> i.e. only the last 11 bits of the</dt>
<dd>IP address are relevant</dd>
</dl>
</li>
<li>Port <strong>1741</strong>, corresponds to port index <strong>1</strong> (1740 = 0)</li>
<li><dl class="first docutils">
<dt>Since 2 bits are required for the port index, this configuration uses</dt>
<dd>13 bits, i.e. the top 3 bits of the first byte remain unused.
They can be used by the router for encoding the subnet ID, for
example.</dd>
</dl>
</li>
</ul>
<img alt="../_images/comm_udp_address_example.png" src="../_images/comm_udp_address_example.png" />
<p>The following source code snippet generates this address from the IP
configuration. Unfortunately several special cases have to be covered
that make the code a little difficult to read. The function expects the
relevant part of the IP address in dwLocalAddr, appends the 2-bit port
index to wPortIdxOffset, and finally converts the required bytes to a
byte array in pnaResult.</p>
<div class="highlight-C"><div class="highlight"><pre><span></span>Static void CreateNetworkAddress(NETWORKADDRESS *pnaResult,
RTS_UI32 dwLocalAddr, int iPortIdx, RTS_UI16 wPortIdxOffset)
/* dwLocalAddr = dwIpAddress &amp; ~dwNetworkMask
 * wPortIdxOffset = &lt;number of non-networkmask bits in the ip-address&gt;
 */
{
 int I;
 RTS_UI16 wLocalAddrLen
 /* wLocalAddrLen = Total number of bytes required for this
     network
  * address. PortIdxOffset equals the number of bits required for
     the
  * ipaddress, then adding 2 bits for the port index and finally
  * calculate the number of bytes, rounding up (&quot;+7&quot;)
  wLocalAddrLen = (wPortIdxOffset + 2 + 7) / 8;
/* Caveat:
 * We are shifting the portidx to the left in order to set the
 * matching bits within the dwLocalAddr. If 31 or even all 32 bits
 * of the ipaddress are used for the local address we need some
 * extra treatment, which is done after the for loop below. So
 * everything should work fine.
 * But if the portidx offset is 32 then (at least on x86 with VC6
 * compiler) the left shift is executed as a shift (I % 32)
 * effectively doing nothing, where zero should result.
 * In short: Expected (x &lt;&lt; 32) == 0, but what we get is
 * (x &lt;&lt; 32) == x.
 * Therefore we exclude that case in the next statement.
 */
   if(wPortIdxOffset &lt; 32)
   dwLocalAddr = dwLocalAddr | (iPortIdx &lt;&lt; wPortIdxOffset);
   pnaResult-&gt;nLength = wLocalAddrLen;
   for(i=wLocalAddrLen-1; i&gt;=0; i--)
   {
   pnaResult-&gt;address[i] = (RTS_UI8)(dwLocalAddr &amp; 0xFF);
   dwLocalAddr = dwLocalAddr &gt;&gt; 8;
   }
   if(wPortIdxOffset &gt; 30)
   {
   pnaResult-&gt;address[0] = iPortIdx &gt;&gt; (32 – wPortIdxOffset);
   }
 }
</pre></div>
</div>
</div>
<div class="section" id="serial-block-driver">
<h2>1.5.10.3. Serial block driver<a class="headerlink" href="#serial-block-driver" title="Permalink to this headline">¶</a></h2>
<p>The serial block driver is called CmpBlkDrvSimpleCom. The driver sends
the following characters for synchronization of each data block:</p>
<ul class="simple">
<li>Block start delimiter: &#8220;#&lt;&#8221;</li>
<li>Block start delimiter: &#8220;#&gt;&#8221;</li>
<li>Within a block each &#8220;#&#8221; is expanded to &#8220;#_&#8221;</li>
</ul>
<p>Each block carries a 16 bit crc over the original data, stored in Intel
byte order. Thus a block looks like this:</p>
<p>&lt;start delimiter&gt;[&lt;data&gt;&lt;crc_highbyte&gt;&lt;crc_lowbyte&gt;]&lt;end delimiter&gt;</p>
<p>Data within [ ] is escaped to the above rule.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="comm_modules.html" title="1.5.11. Modules"
             >next</a> |</li>
        <li class="right" >
          <a href="comm_implement_own_driver.html" title="1.5.9. Implementation of Own Communication Driver"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RuntimeSystemOnlineHelp V3.5.14.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >1. CODESYS Control V3 - Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="communication.html" >1.5. Communication</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, 3S-Smart Software Solutions GmbH.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>