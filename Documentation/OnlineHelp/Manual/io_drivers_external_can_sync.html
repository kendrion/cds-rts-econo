

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>5.8.11. External CAN Sync &#8212; RuntimeSystemDocumentation V3.5.16.40</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/theme.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5.8.12. Byte order specific data handling in IO driver" href="io_drivers_data_handling.html" />
    <link rel="prev" title="5.8.10. Consistency in the IO Driver" href="io_drivers_io_drv_consistency.html" /> 
  </head><body>
	<div id="header">
		<a href="#" title="CODESYS" target="_top" id="logo"><img src="../_static/logo.png" width="134" height="130" alt=""></a>
		<a href="#" title="CODESYS Documentation" target="_top" id="logo-store"><img src="../_static/logo2.png" width="137" height="130" alt=""></a>
	</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="io_drivers_data_handling.html" title="5.8.12. Byte order specific data handling in IO driver"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="io_drivers_io_drv_consistency.html" title="5.8.10. Consistency in the IO Driver"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >5. Architecture Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="io_drivers.html" accesskey="U">5.8. I/O Drivers</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h4>Previous topic</h4>
  <p class="topless"><a href="io_drivers_io_drv_consistency.html"
                        title="previous chapter">5.8.10. Consistency in the IO Driver</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="io_drivers_data_handling.html"
                        title="next chapter">5.8.12. Byte order specific data handling in IO driver</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="external-can-sync">
<span id="io-drivers-external-can-sync"></span><h1>5.8.11. External CAN Sync<a class="headerlink" href="#external-can-sync" title="Permalink to this headline">¶</a></h1>
<p>By default, CAN Sync packets are sent cyclically from the IEC bus cycle
task. This means that, under bad circumstances, the CAN Sync packet will
have a jitter which is equal to the jitter of this cyclically called
task.</p>
<p>In order to generate a more accurate sync signal, it is possible to
generate those packets externally from a hardware timer and to trigger
the CAN task from this timer.</p>
<img alt="../_images/io_drivers_consistency_ext_sync.png" src="../_images/io_drivers_consistency_ext_sync.png" />
<div class="section" id="can-l2-api">
<h2>5.8.11.1. CAN L2 API<a class="headerlink" href="#can-l2-api" title="Permalink to this headline">¶</a></h2>
<p>When sync is enabled in a CAN project, the 3S CANOpen stack calls tries
to enable the external sync mechanism of the CAN driver. This will be
successful if the driver implements the following two functions of the
CAN L2 driver API:</p>
<ul class="simple">
<li><p>CMD_SetBlock()</p></li>
<li><p>CMD_SetCycle()</p></li>
</ul>
<p>The function CMD_SetBlock() is called to pass the sync packet down to
the driver. CMD_SetBlock() is getting a block handle from a block which
contains the sync packet. This function takes control over the passed
block handle. This control is given back to the calling function at the
next call of CMD_SetBlock().</p>
<p>The function CMD_SetCycle() is called by the CAN L2 to define the cycle
time in which a sync packet will be generated. This time value is given
in microseconds and should be used to program a hardware timer.</p>
</div>
<div class="section" id="timer-isr">
<h2>5.8.11.2. Timer ISR<a class="headerlink" href="#timer-isr" title="Permalink to this headline">¶</a></h2>
<p>Within the timer ISR, the CAN driver needs to send the packet to the
CAN. After a send interrupt has signaled that the sync packet was send,
the driver needs to send an event to the motion task.</p>
<img alt="../_images/io_drivers_consistency_ext_sync_timer_isr.png" src="../_images/io_drivers_consistency_ext_sync_timer_isr.png" />
<p><strong>CAN Timer ISR example:</strong></p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">s_pClonedSyncBlock</span> <span class="o">=</span> <span class="n">CAL_CL2_MsgClone</span><span class="p">(</span> <span class="n">CanNet</span><span class="p">,</span> <span class="n">pSavedSyncBlock</span><span class="p">,</span>
<span class="o">&amp;</span><span class="n">error</span> <span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">CL2_NO_ERROR</span><span class="p">)</span> <span class="p">{</span>
<span class="n">CMD_Send</span><span class="p">(</span> <span class="n">CanNet</span><span class="p">,</span> <span class="n">s_pClonedSyncBlock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>CAN Send ISR:</strong></p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">s_pSyncBlockCloned</span> <span class="o">==</span> <span class="n">hBlock</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/* Wake up the Motion Task */</span>
<span class="k">if</span><span class="p">((</span><span class="n">s_hEventCanSync</span> <span class="o">!=</span> <span class="n">RTS_INVALID_HANDLE</span><span class="p">))</span> <span class="p">{</span>
<span class="n">CAL_SysEventSet</span><span class="p">(</span><span class="n">s_hEventCanSync</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="motion-cycle-time">
<h2>5.8.11.3. Motion Cycle Time<a class="headerlink" href="#motion-cycle-time" title="Permalink to this headline">¶</a></h2>
<p>When you are using a target with external sync, you are creating a
motion task which is triggered by an external event. But this also means
that you won’t define a cycle time for this task. This time will be
implicitly defined with the external sync period.</p>
<p>But, because the SoftMotion stack needs to know the cycle time of the
task on which it is running, you need to set this time within your CAN
driver manually. This can be done directly in the function
CMD_SetCycle(), because in this function you get the sync period.</p>
<p>To get the task handle of the motion task, as well as the sync event,
you need to register on the event „TaskCreateDone” of „CmpSchedule”. You
should search for your event name and save a handle to this event, as
well as to the task handle, in a static variable of the driver.</p>
<p><strong>Example of CMD_SetCycle():</strong></p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span>/* set cycle time of IEC task */
if(s_hTaskCanSyncInfo != NULL)
s_hTaskCanSyncInfo-&gt;tInterval = dwCycle;
/* program hardware timer */
…
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="io_drivers_data_handling.html" title="5.8.12. Byte order specific data handling in IO driver"
             >next</a> |</li>
        <li class="right" >
          <a href="io_drivers_io_drv_consistency.html" title="5.8.10. Consistency in the IO Driver"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >5. Architecture Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="io_drivers.html" >5.8. I/O Drivers</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, 3S-Smart Software Solutions GmbH. This document is confidential. Unauthorized copying, disclosure or distribution of this document and the information contained herein is strictly forbidden.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>