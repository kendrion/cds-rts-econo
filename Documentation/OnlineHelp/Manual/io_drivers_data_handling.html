

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>5.8.12. Byte order specific data handling in IO driver &#8212; RuntimeSystemDocumentation V3.5.16.40</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/theme.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5.9. Symbolic IEC Variable Access" href="symb_iecvaraccess.html" />
    <link rel="prev" title="5.8.11. External CAN Sync" href="io_drivers_external_can_sync.html" /> 
  </head><body>
	<div id="header">
		<a href="#" title="CODESYS" target="_top" id="logo"><img src="../_static/logo.png" width="134" height="130" alt=""></a>
		<a href="#" title="CODESYS Documentation" target="_top" id="logo-store"><img src="../_static/logo2.png" width="137" height="130" alt=""></a>
	</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="symb_iecvaraccess.html" title="5.9. Symbolic IEC Variable Access"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="io_drivers_external_can_sync.html" title="5.8.11. External CAN Sync"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >5. Architecture Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="io_drivers.html" accesskey="U">5.8. I/O Drivers</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h4>Previous topic</h4>
  <p class="topless"><a href="io_drivers_external_can_sync.html"
                        title="previous chapter">5.8.11. External CAN Sync</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="symb_iecvaraccess.html"
                        title="next chapter">5.9. Symbolic IEC Variable Access</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="byte-order-specific-data-handling-in-io-driver">
<span id="io-drivers-data-handling"></span><h1>5.8.12. Byte order specific data handling in IO driver<a class="headerlink" href="#byte-order-specific-data-handling-in-io-driver" title="Permalink to this headline">¶</a></h1>
<p>When developing an IO driver for CODESYS Control, the byte order of the
target platform must be regarded. This chapter describes how to create a
portable IO driver which could be executed on both Motorola- and
Intel-byte order platforms.</p>
<div class="section" id="bits-handling-in-byte-word-dword">
<h2>5.8.12.1. Bits handling in BYTE/WORD/DWORD<a class="headerlink" href="#bits-handling-in-byte-word-dword" title="Permalink to this headline">¶</a></h2>
<p>One of the basic tasks during driver development is to control separate
bits. For example this could be the handling of digital inputs/outputs
or handling of control bits in the registers of your peripheral device.</p>
<p>The CODESYS runtime system provides several functions for bit handling
to the drivers’ developer.</p>
<p>The function SysCpuTestAndSetBit() sets (bSet = 1) or resets (bSet = 0)
a specified bit in the bit string with length nLen. Pointers to data
must correspond to the type which is specified by nLen. The function
will return ERR_OK if after the operation the bit has a changed value.
The usage of this function is thread- and interrupt safe. If you want to
set- or reset a bit within a WORD or DWORD, the behavior of the function
depends on the byte order of the platform. Let’s consider how bits are
handled on Motorola and Intel byte order platforms.</p>
<p>For example the following call is executed</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">SysCpuTestAndSetBit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwData</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">)</span><span class="o">:</span>
</pre></div>
</div>
<p>Platform with Intel-byte order:</p>
<img alt="../_images/io_drivers_datahandling_intel.png" src="../_images/io_drivers_datahandling_intel.png" />
<p>Platform with Motorola-byte order:</p>
<img alt="../_images/io_drivers_datahandling_motorola.png" src="../_images/io_drivers_datahandling_motorola.png" />
<p>As shown in the picture above, the function sets the bits within the
DWORD according to the byte order of the platform. That means that the
value of the data accessed by pAddress is independent of the byte order
of the platform, but the appropriate, different bit number is set in
memory. In this example on both kinds of platforms the value of the
accessed data is equal to 32. But while bit number 5 is set on Intel
byte order,, we are setting bit 29 on Motorola byte order.</p>
<p>If the function SysCpuTestAndSetBit() is used for exchanging data
between several software components of the firmware (for example for
tasks synchronization), the position of the bits in memory controlled by
the function doesn’t matter because all intercommunicating parts have
the same byte order and correspondingly access the same memory by the
same bit number.</p>
<p>To set/reset a specific bit in the bit string independently of byte
order you can use the following fact. The behavior of the function is
independent of the platform if nLen = 1, e.g. it the function accesses
bit in byte. So the following code will handle the same bit in memory on
Motorola and Intel byte order platform:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">BitOffsetInDword</span><span class="p">;</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">BitOffsetInByte</span><span class="p">;</span>
<span class="n">ByteOffset</span> <span class="o">=</span> <span class="n">BitOffsetInDword</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
<span class="n">BitOffsetInByte</span> <span class="o">=</span> <span class="n">BitOffsetInDword</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
<span class="n">pbyData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dwData</span><span class="p">;</span>
<span class="n">pbyData</span> <span class="o">=</span> <span class="n">pbyData</span> <span class="o">+</span> <span class="n">ByteOffset</span><span class="p">;</span>
<span class="n">SysCpuTestAndSetBit</span><span class="p">(</span><span class="n">pbyData</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BitOffsetInByte</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
</pre></div>
</div>
<p>This code for example could be used for handling a special bit in the
control register of any peripheral device.</p>
<p>RTS_RESULT SysCpuTestAndSet(unsigned long* pul,int iBit):</p>
<p>This function is used for testing and setting a bit in a DWORD.</p>
<p>RTS_RESULT SysCpuTestAndReset(unsigned long* pul,int iBit):</p>
<p>This function is used for testing and setting a bit in a DWORD.</p>
<p>All these functions are available in C and IEC.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Please always use a pointer to correct the data type in these functions.
Functions SysCpuTestAndSet/SysCpuTestAndReset may never be used for controlling a bit in a
Byte, even if the bit number was always expected to be less than 8. Such code will be executed
without any problems on an Intel CPU but it will cause a damage of the
memory because the number of the bit will not fit into the byte
specified by the pointer. When you are using the newer interface
SysCpuTestAndSetBit() you will not encounter these problems, because the
pointer now points to a BYTE and not to a DWORD anymore.</p>
</div>
</div>
<div class="section" id="helper-functions-for-i-o-update">
<h2>5.8.12.2. Helper functions for I/O update<a class="headerlink" href="#helper-functions-for-i-o-update" title="Permalink to this headline">¶</a></h2>
<p>One of the main tasks during I/O driver development in the runtime
system is writing I/O update functions (see <a class="reference internal" href="io_drivers_interfaces.html#icmpiodrv"><span class="std std-ref">_io_drivers_interfaces</span></a>) which are
responsible for coping I/Os values from/to the hardware (bus). Target
and bus could have different byte order. For example in case of Modbus
the I/Os are transmitted in Motorola byte order but the target might
have Intel byte order. To simplify the handling of Ios the runtime
system provides several helper functions to the driver developer:</p>
<ul class="simple">
<li><p>IoMgrCopyInputLE()</p></li>
<li><p>IoMgrCopyInputBE()</p></li>
<li><p>IoMgrCopyOutputLE()</p></li>
<li><p>IoMgrCopyOutputBE()</p></li>
</ul>
<p>Postfix LE of the helper functions means that the bus has
<strong>L</strong>ittle-<strong>E</strong>ndian (Intel) byte order and accordingly BE means
<strong>B</strong>ig-<strong>E</strong>ndian (Motorola) byte order. The byte order of the
target platform is detected automatically.</p>
</div>
<div class="section" id="representation-of-bit-fields-in-io-configuration">
<h2>5.8.12.3. Representation of bit-fields in IO configuration<a class="headerlink" href="#representation-of-bit-fields-in-io-configuration" title="Permalink to this headline">¶</a></h2>
<p>The values of I/Os can be monitored and controlled in the I/O
configuration of a device. The standard possibility to represent digital
Ios is using bit fields (see <a class="reference internal" href="dev_desc_basics.html#bitfields"><span class="std std-ref">Bitfields</span></a>). If the target has Intel
byte order the bit channels will be displayed in the following way:</p>
<img alt="../_images/io_drivers_datahandling_intel.png" src="../_images/io_drivers_datahandling_intel.png" />
<p>If the target has Motorola byte order, the bytes inside the word will be
swapped. Therefore the Bytes within the Word will be swapped to the
target byte order.</p>
<img alt="../_images/io_drivers_datahandling_motorola.png" src="../_images/io_drivers_datahandling_motorola.png" />
<p>CODESYS provides a possibility to change the representation of a bit
field and swap bytes correspondingly to the type used in the IO
configuration. For this purpose please define a setting in the device
description of the PLC as described in chap 0. This helps to make the
representation more user friendly and independent from a target byte
order.</p>
<img alt="../_images/io_drivers_datahandling_codesys.png" src="../_images/io_drivers_datahandling_codesys.png" />
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="symb_iecvaraccess.html" title="5.9. Symbolic IEC Variable Access"
             >next</a> |</li>
        <li class="right" >
          <a href="io_drivers_external_can_sync.html" title="5.8.11. External CAN Sync"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >5. Architecture Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="io_drivers.html" >5.8. I/O Drivers</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, 3S-Smart Software Solutions GmbH. This document is confidential. Unauthorized copying, disclosure or distribution of this document and the information contained herein is strictly forbidden.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>