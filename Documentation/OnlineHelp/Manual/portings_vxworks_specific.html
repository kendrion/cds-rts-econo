

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>5.4.3. VxWorks Specific Information &#8212; RuntimeSystemDocumentation V3.5.16.40</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/theme.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5.4.4. Windows CE Specific Information" href="portings_win_ce_specific.html" />
    <link rel="prev" title="5.4.2. Linux specific information" href="portings_linux_specific.html" /> 
  </head><body>
	<div id="header">
		<a href="#" title="CODESYS" target="_top" id="logo"><img src="../_static/logo.png" width="134" height="130" alt=""></a>
		<a href="#" title="CODESYS Documentation" target="_top" id="logo-store"><img src="../_static/logo2.png" width="137" height="130" alt=""></a>
	</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="portings_win_ce_specific.html" title="5.4.4. Windows CE Specific Information"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="portings_linux_specific.html" title="5.4.2. Linux specific information"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >5. Architecture Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="portings.html" accesskey="U">5.4. Portings</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h4>Previous topic</h4>
  <p class="topless"><a href="portings_linux_specific.html"
                        title="previous chapter">5.4.2. Linux specific information</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="portings_win_ce_specific.html"
                        title="next chapter">5.4.4. Windows CE Specific Information</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="vxworks-specific-information">
<h1>5.4.3. VxWorks Specific Information<a class="headerlink" href="#vxworks-specific-information" title="Permalink to this headline">¶</a></h1>
<p id="portings-vxworks-specific">The CODESYS runtime system based on VxWorks is realized as Downloadable Kernel Module (DKM). Its build parameters (e.g. compiler tool chain) have to be compatible with the VxWorks Kernel Image (VIP) and, for VxWorks7 systems, also with the used VxWorks kernel configuration, the so called VxWorks Source Build (VSB). For more information about VSB and VIP please refer to WindRiver’s Workbench and VxWorks documentation.
For the bring up and adaption phase of the CODESYS runtime system we recommend to prepare a “full” development VIP that includes all the means to develop, debug and analyze the code WindRiver offers. Especially useful are file system, serial terminal, FTP and Telnet or SSH servers, as well as the use of WindRiver’s debug tools and the SystemViewer.</p>
<p>With Service Release 6.00 of VxWorks 7 WindRiver replaced the toolchain based on GNU by LLVM for the Hardware architectures ARM and X86. With version V3.5.15.40 CODESYSControl also supports LLVM. Please note that the CODESYSControl built with GNU is not able to run on a VxWorks Image built with LLVM and vice versa, which means that users have to order a new Runtime Tool Kit based on LLVM, if they upgrade their ARM or X86 based systems to a newer VxWorks version (VxWorks7 SR6.00 or newer).</p>
<p>In general the CODESYS runtime system for VxWorks prepared and delivered for your target should be able to run out of the box without any modifications of the default configuration values. To start it, you have at first to store the CODESYS DKM “codesyscontrol.out” and the sample configuration file “CODESYSControl.cfg” in the same directory accessible from the target (e.g. “/sd0:1/CODESYS”). To start it just execute following VxWorks C Shell command sequence:</p>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>-&gt; cd &quot;/sd0:1/CODESYS&quot;
-&gt; ld 0,1,&quot;codesyscontrol.out&quot;
-&gt; PlcStart
</pre></div>
</div>
</div></blockquote>
<p>The following sub-chapters describe use cases that require reconfigurations of the runtime as well as preconditions as required of the VxWorks kernel image (VIP).</p>
<div class="section" id="vxworks-timers">
<span id="portings-vxworks-timers"></span><h2>5.4.3.1. VxWorks Timers<a class="headerlink" href="#vxworks-timers" title="Permalink to this headline">¶</a></h2>
<p>There are 3 VxWorks standard timers that may be used within the CODESYS runtime for scheduling and to calculate the CODESYS system time, depending on the VIP configuration:</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>System Clock:</strong> Use the default timer source, if the cycle time of your IEC tasks is constant and needs not to be changed by a call to SysTaskSetInterval. Then scheduling of the IEC tasks depends on the VxWorks system ticks. The clock rate of the system clock should be set to at least 1000 ticks per second. SysTaskSetInterval is implicitly called, if you use e.g EtherCAT with Distributed Clocks (DC) or redundant PLCs. In such a case you have to use Auxiliary Clock.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Auxiliary Clock:</strong> Use this timer source, if the cycle time of your IEC tasks needs to be adapted during runtime. This is the case, if the cycle interval needs to be synchronized with an external time, e.g. with distributed clocks of an EtherCAT device. To use this timer as the source for scheduling and synchronize with DC, the maximal clock rate of the VIP has to support at least 5000 ticks per second (200 microseconds per tick).</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Timestamps counter:</strong> This timer is used to calculate the system time with an accuracy of micro- or even nanoseconds. As precondition the according hardware timer has to run at a frequency of at least 1MHz. If your CODESYS application requires distributed clocks, the user either needs the VxWorks timestamps or an external function to get the system time with a resolution of at least 1 microsecond.</div>
</div>
</li>
</ul>
<p>Depending on the timer configuration and the settings in the CODESYS configuration file the CODESYS runtime determines the operation mode for scheduling and system time calculation. This mode is the base of the system components SysTimer, SysTime and SysTask.</p>
<p>The default configuration for CODESYS task scheduling and system timers of the CODESYS runtime uses VxWorks system clock (VxWorks.TimerSource=System). This means that the task scheduling of all tasks is based on the VxWorks system tick.
The other possibility is to use Auxiliary Clock (VxWorks.TimerSource=Auxiliary), if the scheduling of the task needs to be synchronized with an external time base, as for example Distributed Clocks of EtherCAT or redundant PLCs.</p>
<p>The CODESYS runtime system provides the component SysTime for determining the system time in micro- or nanoseconds through the functions SysTimeGetUs() and SysTimeGetNs(). However, the accuracy of these functions is depending on the VIP configuration. To get a resolution better than the VxWorks tick rate the timestamps timer with a frequency of at least 1MHz has to be available. During the initialization phase of the CODESYS runtime system, it analyzes the available VxWorks timers and determines the “timestampMode” (see SysTimerItf.h -&gt; VxWorks.TimeStampMode). The resulting mode is send to the CODESYS runtime system logger. For more information about the log messages see chapter: <a class="reference internal" href="#portings-vxworks-timer-usage"><span class="std std-ref">CODESYSControl VxWorks Timer Usage: Information, Warnings and Errors</span></a></p>
</div>
<div class="section" id="codesys-control-timestamp-modes">
<span id="portings-vxworks-timestamp-modes"></span><h2>5.4.3.2. CODESYS Control Timestamp Modes<a class="headerlink" href="#codesys-control-timestamp-modes" title="Permalink to this headline">¶</a></h2>
<p>The Timestamp mode determined is the base of the calculation of the system time of CODESYS Control. It is a combination of VxWorks System Tick counter and the Timestamp counter, if available. Following Timestamp modes are possible:</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>UnknownTimestampMode</strong>   Default mode at startup: Timer mode is not yet defined</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>NoTick</strong>   Timestamps timer is not supported by the VIP or cannot be used. This means that system ticks (System Clock) are used to determine the system time. In such a case the time resolution is limited to the resolution of the system clock. Default value of the CODESYS runtime is 1ms.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>TickPeriodic</strong>   Time is based on system ticks and the periodically counting timestamps timer. This mode is used if the System Clock and the Timestamps counters are based on the same HW timer. The use of the timers is configured in the VIP. This is one of the preferred modes depending on the capabilities of the hardware.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>TimestampContinuous</strong>   Continuously counting timestamps timer with 32-bit used to calculate time. This mode is preferable, if the timer counts a long period until rolling over. Don’t use it, if rollover period is only one or few milliseconds, even if this is the default setting of the BSP. This leads to complex and costly time calculations!</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>TimestampContinuous64</strong>   Continuously counting timestamps timer with 64 bit used to calculate time. This mode is recommended, if a 64-bit counter is available and if it counts a long period until rolling over.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>TimestampPeriodic</strong>   CODESYS System Time calculation and scheduling is based on the timestamp timer rollover count and timestamp timer value. The mode is set, if the timestamp period equals one system tick. Even if this configuration is the default of many VxWorks BSPs, it should be avoided, because it leads to complex and costly time calculations.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>TimestampMode Configuration</strong></div>
<div class="line">The timer mode determined by CODESYS Control is logged, if the logger is enabled.</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>2019-09-03T10:35:31Z: Cmp=SysTimer, Class=1, Error=0, Info=0, pszInfo= VxWorks.TimerSource: Auxiliary Clock - OneShot
2019-09-03T10:35:31Z: Cmp=SysTimer, Class=1, Error=0, Info=0, pszInfo= VxWorks.TimeStampMode: 2 TickPeriodic
</pre></div>
</div>
</div></blockquote>
<p>The user may overload the functions SysTimeGetUs() and SysTimeGetNs(). In such a case the TimestampMode is not important and the use of the VxWorks timestamps timer should be disabled. For more information refer to: <a class="reference internal" href="#portings-vxworks-overload-systime-functions"><span class="std std-ref">Overload Functions of SysTime</span></a></p>
<p>For more information about the TimestampMode refer to chapter: <a class="reference internal" href="#portings-vxworks-timer-usage"><span class="std std-ref">CODESYSControl VxWorks Timer Usage: Information, Warnings and Errors</span></a>.</p>
</div>
<div class="section" id="oneshotmode-for-variable-task-cycle-intervals-e-g-distributed-clocks-redundant-plcs">
<span id="portings-vxworks-oneshotmode"></span><h2>5.4.3.3. OneShotMode for Variable Task Cycle Intervals (e.g. Distributed Clocks, redundant PLCs)<a class="headerlink" href="#oneshotmode-for-variable-task-cycle-intervals-e-g-distributed-clocks-redundant-plcs" title="Permalink to this headline">¶</a></h2>
<p>OneShotMode is used by some field buses (e.g. EtherCAT) or other use cases (e.g. redundant PLCs) to synchronize the cycle start times with an external time base. CODESYS Control on VxWorks requires the Auxiliary clock to support this feature. To use Distributed Clocks the VIP, respectively the used hardware timer, has to be able to provide clock rates above at least 5000 ticks per second to minimize the jitter against the distributed clock of the field bus. To achieve this synchronization the CODESYS scheduler for VxWorks determines and sets the cycle interval of a task with IEC function SysTaskSetInterval, when a task has to be activated the next time and calculates the clock rate of the Auxiliary clock accordingly. To determine the configuration of the clocks on the target with a version greater or equal to VxWorks 6.9 you can use following shell command, if it is configured into the VxWorks kernel image:</p>
<blockquote>
<div><p>Example: vxbAuxClkShow</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>-&gt; vxbAuxClkShow
***  Auxiliary Clock details  ***
aux clock timer address 0x2024f8d8
allocated flag          01
clkFrequency            24000000
minFrequency            1
maxFrequency            5000
features                0x8b
name                    omap35xxTimer
RollOverPeriod          178 secs
</pre></div>
</div>
<p>In this example the frequency of the used timer is 24MHz
The highest tick rate (interrupts / second) = 5000. That means that the minmimal timer interval between 2 tick interrupts = 200 microseconds.</p>
</div></blockquote>
<p>A further precondition to support distributed clocks is a system time with a resolution better than at least 1 microsecond. This can either be realized by using the VxWorks timestamps timer or by providing functions with the required accuracy.
To enable OneShotMode refer to <a class="reference internal" href="#portings-vxworks-enable-oneshotmode"><span class="std std-ref">Enable OneShoMode</span></a></p>
<p>When using Auxiliary clock, the tasks are still scheduled by the VxWorks Scheduler, but are triggered from different „high-level schedulers”:</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>Cyclic Tasks:</strong> Triggered by the high-precision timeout scheduler.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Event Tasks:</strong> Triggered by the runtime scheduler. The variable is checked in the interval given in the configuration file.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Freewheeling:</strong> Those tasks are running all the time, and are interrupting themselves after every cycle for a small amount of time to give control to the communication subsystem. The tasks are woken up by the high-precision timeout scheduler.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>External Event Tasks:</strong> Triggered by an external Event. This can be generated in every context and therefore depends on the context where the event is generated.</div>
</div>
</li>
</ul>
</div>
<div class="section" id="jitter-considerations">
<span id="portings-vxworks-jitter"></span><h2>5.4.3.4. Jitter Considerations<a class="headerlink" href="#jitter-considerations" title="Permalink to this headline">¶</a></h2>
<p>Since CODESYS Version 3.5.13.x callback routines (e.g. of the components SysTask or SysTimer) are no more executed in interrupt, but in context of a task level interrupt handler thread. This may have influence on the jitter of the CODESYS tasks, if external higher level tasks are executed. Therefore, we introduced a setting to change the priority of this task. (see also chapter Configuration Examples - Second Level IRQ Handler Task).</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>Uni-Processor Systems:</strong> VxWorks is running on a single processor core</div>
<div class="line">Jitter of the tasks highly depends on their priorities. For real-time Ethernet protocols as EtherCAT, we recommend to set the priority of the tNet0 task to a value in between the range of TASKPRIO_REALTIME_BASE and TASKPRIO_REALTIME_END tasks priorities. This offers the user the possibility to set task priorities within his application depending on, when Ethernet packages needs to be handled by the task.</div>
<div class="line">However, such a setting may cause that the Ethernet stack of VxWorks is running out of message buffers, especially if EtherCAT with Distributed Clocks is used. In such a case set the priority of the according tNet task to TASKPRIO_SYSTEM_END or even above.</div>
<div class="line">Please note that any Ethernet package is handled by the assigned tNet task. That means that any task with a lower priority will be delayed, if a Ethernet message of a low priority task is sent or received in parallel.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Multi-Core Systems</strong> VxWorks is running on more than one processor core</div>
<div class="line">Jitter of the tasks highly depends also on multi core systems on their priorities. However, the dependency is less distinctive, because a task with lower priority may also be executed in parallel, if a core is free. VxWorks offers on such systems to assign tNet tasks to each processor core. We recommend for real-time Ethernet protocols to use this feature and assign a higher priority in between the range of TASKPRIO_REALTIME_BASE and TASKPRIO_REALTIME_END (or even higher) to the according tNet task.</div>
</div>
</li>
</ul>
<p>For more information on tNet tasks, refer to the VxWorks documentation of Wind River and chapter <a class="reference internal" href="#portings-vxworks-configuration-examples-vip-tnet"><span class="std std-ref">VxWorks tNet Task(s)</span></a></p>
<p><strong>OneShotMode</strong></p>
<p>The jitter caused by using VxWorks Auxiliary clock is in between the time windows [-AuxClkRate/2; +AuxClkRate/2]. This is caused by the minimal interval between to AuxClk-interrupts (see example vxbAuxClkShow above). CODESYS scheduler calculates the next wakeup timeout and reprograms the AuxClkRate accordingly. The IEC task gets active, if the point in time the interrupt occures is later than the lower limit of the time window above.</p>
<p>Additional jitter may be caused by the setting of the TaskSupervisor mode defined in CmpScheduleItf.h. Refer to <a class="reference internal" href="#portings-vxworks-tasksupervisor"><span class="std std-ref">TaskSupervisor Mode</span></a> to minimize this jitter</p>
</div>
<div class="section" id="codesys-control-default-configuration">
<span id="portings-vxworks-default-configuration"></span><h2>5.4.3.5. CODESYS Control Default Configuration<a class="headerlink" href="#codesys-control-default-configuration" title="Permalink to this headline">¶</a></h2>
<ul>
<li><div class="line-block">
<div class="line"><strong>Timer Source:</strong></div>
<div class="line">The default “VxWorks.TimerSource” is “System”.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Scheduling Mode:</strong></div>
<div class="line">The default scheduling mode for VxWorks is set in the header file “sysdefines.h” to “OSScheduler”.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Timestamps:</strong></div>
<div class="line">The CODESYS runtime system uses the VxWorks timestamps timer as default .</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>To overload the default values above change the according settings in the configuration file “CODESYSControl.cfg” of the target.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="codesys-control-configuration-examples">
<span id="portings-vxworks-configuration-examples"></span><h2>5.4.3.6. CODESYS Control Configuration Examples<a class="headerlink" href="#codesys-control-configuration-examples" title="Permalink to this headline">¶</a></h2>
<p>Edit the CODESYS runtime system configuration file CODESYSControl.cfg accordingly and store it in the directory of your target, from where you start it.</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>Setting IEC Cycle Interval:</strong></div>
<div class="line">The tick rate (timer interrupts per second) can be influenced by the following setting in the configuration file.</div>
<div class="line">With the example below the minimal cycle time is set to 1000 microseconds, which results in a clock rate of 1000 ticks per second. The default value (SCHEDULEKEY_INT_SCHEDULER_INTERVAL_DEFAULT) is defined in the header file CmpScheduleItf.h and changes the VxWorks system clock rate accordingly, if required. However, because WindRiver recommends not to change the system clock rate during runtime, set it during boot up phase of VxWorks and change SchedulerInterval in the configuration file accordingly.</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[CmpSchedule]
SchedulerInterval=1000
</pre></div>
</div>
</div></blockquote>
<ul id="portings-vxworks-overload-systime-functions">
<li><div class="line-block">
<div class="line"><strong>Overload Functions of SysTime</strong></div>
<div class="line">Some targets offer hardware means to easily determine the system time beside the VxWorks timers (e.g. through time registers). In such a case the user can overload the functions SysTimeGetUs() and SysTimeGetNs() with his own implementation through the following settings in CODESYSControl.cfg. In this example represent “MySysTimeGetUs” and “MySysTimeGetNs” functions the user has to implement e.g. as a Downloadable Kernel Module.</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[SysTime]
VxWorks.CustomSysTimeGetUs=MySysTimeGetUs
VxWorks.CustomSysTimeGetNs=MySysTimeGetNs
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SysTimeGetMs(), SysTimeGetUs() and SysTimeGetNs() have to use the same time base. This means that the time values returned by these functions have to fit to following rule:
SysTimeMs = SysTimeUs/1000 = SysTimeNs/1000000
This can be checked by executing SysTimePrint in the VxWorks target shell.</p>
</div>
</div></blockquote>
<ul id="portings-vxworks-enable-oneshotmode">
<li><div class="line-block">
<div class="line"><strong>Enable OneShotMode</strong></div>
<div class="line">The Distributed Clocks feature can be enabled with the following setting in the runtime configuration file:</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[SysTimer]
VxWorks.TimerSource=Auxiliary
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line">Beginning with CODESYS version 3.5.15.x it is no more possible to explicitly set VxWorks.TimerMode. It is now directly bound to the setting of VxWorks.TimerSource.</div>
<div class="line">If set to:</div>
<div class="line-block">
<div class="line">VxWorks.TimerSource=System =&gt; VxWorks.TimerMode=Periodic</div>
<div class="line">VxWorks.TimerSource=Auxiliary =&gt; VxWorks.TimerMode=OneShot</div>
</div>
</div>
</div>
</div></blockquote>
<ul id="portings-vxworks-tasksupervisor">
<li><div class="line-block">
<div class="line"><strong>TaskSupervisor Mode</strong></div>
<div class="line">The default configuration is defines in CmpScheduleItf.h. To minimize jitter in OneShotMode use the setting below. For further information refer to the documentation of CmpSchedule.</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[CmpSchedule]
Scheduling.TaskSupervisor=WatchdogTimer
</pre></div>
</div>
</div></blockquote>
<ul>
<li><div class="line-block">
<div class="line"><strong>Disable Use of VxWorks Timestamps Timer</strong></div>
<div class="line">This may be necessary, if the timestamp timer may not be used within CODESYS Control. To switch off the use of VxWorks timestamps timer add following setting:</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[SysTime]
VxWorks.UseTimestamp=0
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="configuration-examples-of-the-vxworks-kernel-image">
<span id="portings-vxworks-configuration-examples-vip"></span><h2>5.4.3.7. Configuration Examples of the VxWorks Kernel Image<a class="headerlink" href="#configuration-examples-of-the-vxworks-kernel-image" title="Permalink to this headline">¶</a></h2>
<p>This chapter is about the settings of the VxWorks Kernel Image (VIP) that influences the behavior and the features of CODESYS Control.</p>
<p><strong>TimestampMode</strong>
CODESYS Control automatically determines the timestamp mode out of the VxWorks timer configuration. CODESYS Control uses VxWorks System clock and if available the VxWorks timestamp timer to calculate the uptime of the CODESYS runtime. VxWorks Auxiliary clock is used, if OneShotMode is required, e.g. to synchronize time with an external time source as EtherCAT Distributed Clock. For more information about available TimestampModes refer to: <a class="reference internal" href="#portings-vxworks-timestamp-modes"><span class="std std-ref">CODESYS Control Timestamp Modes</span></a></p>
<ul>
<li><div class="line-block">
<div class="line"><strong>Preferred TimestampModes: TimestampContinuous64</strong></div>
<div class="line">This mode is recommended on systems with a 64-bit timestamp timer under the precondition of a long rollover period of the underlying hardware timer. The interval of the rollover period is calculated by the returned values of VxWorks system functions sysTimestamp64Period devided by the frequency of the hardware timer sysTimestamp64Freq. See following example to check whether a 64-bit timer is enabled in the VIP. The configuration file prjParams.h is auto-generated by WindRiver’s WorkBench and in general is stored in the root directory of the VIP project. For further details please refer to the documentation of Wind River.</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="c1">// prjParams.h</span>

<span class="cp">#define INCLUDE_TIMESTAMP64</span>
<span class="cp">#define INCLUDE_VXB_TIMESTAMP</span>
<span class="cp">#define INCLUDE_VXB_TIMESTAMP64</span>
<span class="cp">#define TIMESTAMP_TIMER_NAME &quot;iaTimestamp&quot; </span><span class="c1">// just an example for a 64 bit timer driver</span>
</pre></div>
</div>
</div></blockquote>
<ul id="portings-vxworks-configuration-examples-vip-timestampcontinuous">
<li><div class="line-block">
<div class="line"><strong>Prefered TimestampModes: TimestampContinuous</strong></div>
<div class="line">This mode is recommended on systems with a 32-bit timestamp timer under the precondition of a long rollover period of the underlying hardware timer. The interval of the rollover period is calculated by the returned values of VxWorks system functions sysTimestampPeriod devided by the frequency of the hardware timer sysTimestampFreq. For further details please refer to the documentation of Wind River.</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line">This mode should NOT be used, if the rollover period is just some milliseconds, as it is the case in many default configurations of a VIP. In such a case the calculation of the CODESYS system time is time consuming and may be imprecise. Use TimestampTickPeriodic instead!</div>
<div class="line">To calculate the roll over period divide the returned value of sysTimestampPeriod by sysTimestampFreq:</div>
<div class="line"><br /></div>
<div class="line">RolloverPeriod = sysTimestampPeriod / sysTimestampFreq</div>
</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Preferred TimestampModes: TimestampTickPeriodic</strong></div>
<div class="line">This mode is recommended on systems, which don’t support 64-bit timers and, if the rollover period of the VxWorks timestamp timer is too short. To set this mode VxWorks system clock and timestamp counter are based on the same hardware timer. Refer e.g. to prjParams.h, that is auto-generated by WindRiver’s WorkBench.</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="c1">// prjParams.h</span>

<span class="cp">#define SYSCLK_TIMER_NAME &quot;omap35xxTimer&quot;</span>
<span class="cp">#define SYSCLK_TIMER_NUM 0</span>
<span class="cp">#define TIMESTAMP_TIMER_NAME &quot;omap35xxTimer&quot;</span>
<span class="cp">#define TIMESTAMP_TIMER_NUM 0</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><div class="line-block">
<div class="line"><strong>VxWorks Timer Configuration</strong></div>
<div class="line">To determine the configuration of the VxWorks Timers on the target with a version greater or equal to VxWorks 6.9 you can use vxbSysClkShow, vxbAuxClkShow and vxbTimestampShow shell commands, if they are configured into the VxWorks kernel image. The configuration in the example below results in timestamp mode TimestampTickPeriodic, because VxWorks system clock and timestamps timer use the same hardware timer: “Timestamp address” is equal to “sys clock timer address” (=0x2024fe78). Feature “0x8b” indicates a 32-bit counter.</div>
</div>
<p>Example: vxbAuxClkShow</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>-&gt; vxbAuxClkShow
***  Auxiliary Clock details  ***
aux clock timer address 0x2024f8d8
allocated flag          01
clkFrequency            24000000
minFrequency            1
maxFrequency            5000
features                0x8b
name                    omap35xxTimer
RollOverPeriod          178 secs

-&gt; vxbTimestampShow
***  Timestamp details  ***
Timestamp address       0x2024fe78
allocated flag          01
clkFrequency            24000000
minFrequency            1
maxFrequency            8000
features                0x8b
name                    omap35xxTimer
RollOverPeriod          178 secs

-&gt; vxbSysClkShow
***  System Clock details  ***
sys clock timer address 0x2024fe78
allocated flag          01
clkFrequency            24000000
minClkRate              60
maxClkRate              4000
features                0x8b
name                    omap35xxTimer
RollOverPeriod          178 secs
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The value “RollOverPeriod” of sysTimestampShow may be different from the “real” rollover period. For more details refer to the documentation of Wind River and to <a class="reference internal" href="#portings-vxworks-configuration-examples-vip-timestampcontinuous"><span class="std std-ref">Prefered TimestampModes: TimestampContinuous</span></a></p>
</div>
</li>
</ul>
<ul id="portings-vxworks-configuration-examples-vip-tnet">
<li><div class="line-block">
<div class="line"><strong>VxWorks tNet Task(s)</strong></div>
<div class="line">VxWorks 7 offers the possibility to assign tasks to dedicated network controllers and even bind them to a dedicated core on SMP systems. Following settings bind the task tNet0 to network controller 0 and CPU1 with the priority 64 and tNet1 to network controller 1 and CPU2 with the priority 30.</div>
</div>
</li>
</ul>
<blockquote>
<div><div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="c1">// prjParams.h</span>

<span class="cp">#define NET_TASK_PRIORITIES &quot;0,64;1,30&quot;         </span><span class="c1">// priorities tNet0: 64 and tNet1: 30</span>
<span class="cp">#define NET_DAEMONS_CPU_AFFINITY TRUE</span>
<span class="cp">#define NET_DAEMONS_CPU_AFFINITIES &quot;0,1;1,2&quot;    </span><span class="c1">// assign tNet0 to CPU1 and tNet1 to CPU2</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="codesyscontrol-vxworks-timer-usage-information-warnings-and-errors">
<span id="portings-vxworks-timer-usage"></span><h2>5.4.3.8. CODESYSControl VxWorks Timer Usage: Information, Warnings and Errors<a class="headerlink" href="#codesyscontrol-vxworks-timer-usage-information-warnings-and-errors" title="Permalink to this headline">¶</a></h2>
<p>The CODESYS components SysTimer, SysTime, SysTask (CmpSchedule) depend on the usage of VxWorks timer configuration (SysClk, AuxClk, Timestamp) and their capabilities. The CODESYS runtime sends various logger messages during initialization phase and also during run time to detect any configuration problems. Following messages may occur:</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>VxWorks.TimerSource: System - Periodic</strong></div>
<div class="line">Information: CODESYS Runtime System uses VxWorks SysClk for scheduling</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>VxWorks.TimerSource: Auxiliary - OneShot</strong></div>
<div class="line">Information CODESYS Runtime System uses VxWorks AuxClk for scheduling in OneShot mode</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>VxWorks.TimeStampMode: &lt;no&gt; - &lt;mode&gt;</strong></div>
<div class="line">Information: CODESYS Runtime System: calculation of time is based on:</div>
</div>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 26%" />
<col style="width: 67%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>&lt;no&gt;</p></td>
<td><p>&lt;mode&gt;</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>UnknownTimestampMode</p></td>
<td><p>mode not yet defined</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Tick</p></td>
<td><p>Timestamps timer not used -&gt; tick mode
time based on VxWorks system ticks</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>TimestampTickPeriodic</p></td>
<td><p>Time is based on system ticks and the periodically
counting timestamps timer (preferred with 32-bit timers)</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>TimestampContinuous</p></td>
<td><p>Continuously counting timestamps timer (32 bit)
used to calculate time</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>TimestampContinuous64</p></td>
<td><p>Continuously counting timestamps timer (64 bit)
used to calculate time (preferred with 64-bit timers)</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><div class="line-block">
<div class="line"><strong>System Clock Rate has been changed during initialization!</strong></div>
<div class="line">Information: HWT_CLK_CONF_INFO_SYSCLK_CHANGED</div>
<div class="line">CODESYS runtime system has changed VxWorks sysClkRate during initialization phase.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Auxiliary Clock cannot support all frequencies!</strong></div>
<div class="line">Error: HWT_CLK_CONF_ERROR_AUX_ALLFRQS</div>
<div class="line">VxWorks Auxiliary clock cannot support all frequencies.</div>
<div class="line">-&gt; fall back: TimerSource = System</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Setting of Auxiliary Clock Rate failed</strong></div>
<div class="line">Error: HWT_CLK_CONF_ERROR_AUX_SET</div>
<div class="line">VxWorks Auxiliary clock cannot support the requested clock rate</div>
<div class="line">-&gt; wrong configuration of the VIP or the Board Support Package</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Auxiliary Clock is not supported!</strong></div>
<div class="line">Error: HWT_CLK_CONF_ERROR_AUX_NOTSUP</div>
<div class="line">VxWorks Auxiliary clock is not configured into the VxWork kernel image (VIP)</div>
<div class="line">-&gt; fall back: TimerSource = System</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Wrong maxFrequency setting in Auxiliary Clock configuration</strong></div>
<div class="line">Error: HWT_CLK_CONF_ERROR_AUX_MAXFRQ</div>
<div class="line">VxWorks Auxiliary clock does not support the maxFrequency as defined in the timer handle.</div>
<div class="line">This may be an error of the VxWorks kernel configuration. Auxiliary clock cannot be used.</div>
<div class="line">-&gt; fall back: TimerSource = System</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Setting of System Clock Rate failed!</strong></div>
<div class="line">Error: HWT_CLK_CONF_ERROR_SYSTEM_SET</div>
<div class="line">VxWorks System clock cannot support requested clock rate. This may be an error of the VxWorks kernel</div>
<div class="line">configuration. Recommended value for System Clock rate is 1000 [ticks/second].</div>
<div class="line">-&gt; VxWorks System timer cannot set requested CODESYS cycle time</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Tried to use OneShot mode without VxWorks Timestamps support!</strong></div>
<div class="line">Error: HWT_CLK_CONF_ERROR_DC_TS</div>
<div class="line">CODESYS Runtime System cannot use VxWorks timestamps</div>
<div class="line">VxWorks timestamps timer cannot be used (VxWork.UseTimestamps=0) or</div>
<div class="line">VxWorks timestamps timer is not available in VIP</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Tried to change System Clock Rate in periodic mode during runtime!</strong></div>
<div class="line">Error: HWT_CLK_CONF_ERROR_DC_SYSCLK</div>
<div class="line">CODESYS runtime system must not change sysClkRate after initialization</div>
<div class="line">Example: CODESYS application tried to change cycle time, but VxWorks.TimerSource=System</div>
<div class="line">-&gt; Cycle time is not changed</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>System Clock cannot support scheduler cycle time!</strong></div>
<div class="line">Error: HWT_CLK_CONF_ERROR_SYSCLK</div>
<div class="line">CODESYS runtime system cannot set clock rate to achieve cycle time</div>
<div class="line">-&gt; change VxWorks maximal SysClkRate to fit to CODESYS cycle time</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>System Clock Rate is lower than 1000 ticks/s (1ms)!</strong></div>
<div class="line">Warning: HWT_CLK_CONF_WARNING_SYSCLK</div>
<div class="line">CODESYS runtime system cannot set clock rate to achieve recommended cycle time (1ms)</div>
<div class="line">-&gt; change VxWorks maximal SysClkRate to fit to CODESYS cycle time of 1ms</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Tried to set cycle interval to 0!</strong></div>
<div class="line">Error: HWT_CLK_CONF_ERROR_INTERVAL_0</div>
<div class="line">Maybe time calculation error or cycle time explicitly set to 0</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Wrong maximal frequency setting of Auxiliary Clock detected!</strong></div>
<div class="line">Warning: HWT_CLK_CONF_WARNING_AUX_MAXFRQ</div>
<div class="line">The maximal VxWorks AuxClkRate as read from Auxiliary timer handle (&gt;= VxWorks 6.9) cannot be set.</div>
<div class="line">Wrong Auxiliary Clock configuration in VxWorks Kernel Image or Board Support Package</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Wrong minimal frequency setting of Auxiliary Clock detected!”</strong></div>
<div class="line">Warning: HWT_CLK_CONF_WARNING_AUX_MINFRQ</div>
<div class="line">The minimal VxWorks AuxClkRate as read from Auxiliary timer handle (&gt;= VxWorks 6.9) cannot be set.</div>
<div class="line">Wrong Auxiliary Clock configuration in VxWorks Kernel Image or Board Support Package</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Tried to set Cycle Interval to 0!</strong></div>
<div class="line">Warning: HWT_CLK_CONF_WARNING_INTERVAL_0</div>
<div class="line">Tried to set the cycle interval of a task to 0.</div>
<div class="line">CODESYS Runtime System adjusted the interval to the next possible value.</div>
</div>
</li>
</ul>
</div>
<div class="section" id="global-object-pool">
<span id="portings-vxworks-global-object-pool"></span><h2>5.4.3.9. Global Object Pool<a class="headerlink" href="#global-object-pool" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">to share or communicate with external applications or modules, which are not running inside of the CODESYS Runtime. For such scenarios, CODESYS on VxWorks provides a global object pool for:</div>
</div>
<ul class="simple">
<li><p>sending events</p></li>
<li><p>sharing semaphores and memory</p></li>
</ul>
<div class="line-block">
<div class="line">To share the global symbol table across application image boundaries, the runtime emits a new symbol at first startup, called „g_PlcObjTab”. The memory within this table is allocated dynamically on the heap and does not exclusively belong to the process image.</div>
<div class="line">To use the objects independently from the outside of CODESYS runtime, you can include the data from the table manually into an external application. The actual version of the shared object table is defined in <strong>sysspecific.h</strong> and has the following structure:</div>
</div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define OBJTAB_VERSION 0x00000001</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="n">objTabType_e</span>
<span class="p">{</span>
  <span class="n">e_shm</span><span class="p">,</span>
  <span class="n">e_sem</span><span class="p">,</span>
  <span class="n">e_evt</span>
<span class="p">}</span> <span class="n">objTabType_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">shmEntry_s</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ulAddress</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ulSize</span><span class="p">;</span>
<span class="p">}</span> <span class="n">shmEntry_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">semEntry_s</span>
<span class="p">{</span>
   <span class="n">SEM_ID</span> <span class="n">hSem</span><span class="p">;</span>
<span class="p">}</span> <span class="n">semEntry_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">evtEntry_s</span>
<span class="p">{</span>
   <span class="n">SEM_ID</span> <span class="n">hEvt</span><span class="p">;</span>
<span class="p">}</span> <span class="n">evtEntry_t</span><span class="p">;</span>

<span class="cm">/* base type, which „contains&quot; the above */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">objEntry_s</span>
<span class="p">{</span>
   <span class="n">objTabType_t</span> <span class="n">tType</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">pszName</span><span class="p">;</span>
   <span class="k">union</span>
   <span class="p">{</span>
       <span class="n">shmEntry_t</span> <span class="n">tShmEntry</span><span class="p">;</span>
       <span class="n">semEntry_t</span> <span class="n">tSemEntry</span><span class="p">;</span>
       <span class="n">evtEntry_t</span> <span class="n">tEvtEntry</span><span class="p">;</span>
   <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">}</span> <span class="n">objEntry_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">objTab_s</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ulVersion</span><span class="p">;</span>
   <span class="n">SEM_ID</span> <span class="n">hSem</span><span class="p">;</span>
   <span class="n">objEntry_t</span> <span class="o">*</span><span class="n">ptEntries</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ulSize</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ulRefCnt</span><span class="p">;</span>
<span class="p">}</span> <span class="n">objTab_t</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="portings_win_ce_specific.html" title="5.4.4. Windows CE Specific Information"
             >next</a> |</li>
        <li class="right" >
          <a href="portings_linux_specific.html" title="5.4.2. Linux specific information"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >5. Architecture Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="portings.html" >5.4. Portings</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, 3S-Smart Software Solutions GmbH. This document is confidential. Unauthorized copying, disclosure or distribution of this document and the information contained herein is strictly forbidden.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>