

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>6.2.3.6. A: [Step by Step] Creating a new Component &#8212; RuntimeSystemDocumentation V3.5.16.40</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/theme.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6.2.3.7. B: [Step by Step] Compiling a Component" href="appendix_B.html" />
    <link rel="prev" title="Create an I/O Driver" href="create_io_driver_create_driver.html" /> 
  </head><body>
	<div id="header">
		<a href="#" title="CODESYS" target="_top" id="logo"><img src="../../_static/logo.png" width="134" height="130" alt=""></a>
		<a href="#" title="CODESYS Documentation" target="_top" id="logo-store"><img src="../../_static/logo2.png" width="137" height="130" alt=""></a>
	</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="appendix_B.html" title="6.2.3.7. B: [Step by Step] Compiling a Component"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="create_io_driver_create_driver.html" title="Create an I/O Driver"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">6.2.3. Creating Runtime System Components, Libraries and I/O Drivers</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h4>Previous topic</h4>
  <p class="topless"><a href="create_io_driver_create_driver.html"
                        title="previous chapter">Create an I/O Driver</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="appendix_B.html"
                        title="next chapter">6.2.3.7. B: [Step by Step] Compiling a Component</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="a-step-by-step-creating-a-new-component">
<span id="tutorial-creating-components-libraries-iodrivers-appendix-a"></span><h1>6.2.3.6. A: [Step by Step] Creating a new Component<a class="headerlink" href="#a-step-by-step-creating-a-new-component" title="Permalink to this headline">¶</a></h1>
<p>To create a new component, the CmpTemplateEmpty component can be used as
a starting point. The CmpTemplateEmpty is included in the runtime system
delivery.</p>
<p>To copy and rename the files, you have two possiblities:</p>
<p>1) (recommended method): you can use the Python script
gen_cmp_from_temp.py. To run the script, you need Python installed. The
script can be used like this:</p>
<blockquote>
<div><p>gen_cmp_from_temp [-h] [-t TEMPLATE] [-c CMPNAME] [-a TRGARCH]</p>
<p>TEMPLATE is the template component name which is used for generating
component/driver.</p>
<p>CMPNAME is the name for the target component</p>
<p>TRGARCH is the target architecture, options (only capital letter):
X86 | PPC | ARM | CORTEX.</p>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>Open a command prompt (DOS/shell) and go to the runtime Templates</dt><dd><p>folder (e.g. D:SVNCodesysSpV3trunkCodesysSpV3Templates)</p>
</dd>
</dl>
</li>
<li><p>Run &gt;gen_cmp_from_temp -t CmpTemplateEmpty –c CmpTest</p></li>
</ul>
<blockquote>
<div><p>This will create a new folder with the given name.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>copy and rename the files by hand, please follow these steps:</p></li>
</ol>
<ul>
<li><p>Copy the CmpTemplateEmpty folder and rename the folder to the new
component name.</p>
<div class="line-block">
<div class="line">Delete all files from your component folder, except:</div>
<div class="line">CmpTemplateEmpty.c</div>
<div class="line">CmpTemplateEmptyDep.m4</div>
</div>
<div class="line-block">
<div class="line">CmpTemplateEmptyItf.m4</div>
<div class="line">CmpTemplateEmptyItf_m4.bat</div>
</div>
<p>CmpTemplateEmptyItf_m4.bat</p>
</li>
<li><div class="line-block">
<div class="line">Rename all files to the new component name (e.g. CmpTest):</div>
<div class="line">CmpTemplateEmpty.c -&gt; CmpTest.c</div>
<div class="line">CmpTemplateEmptyDep.m4 -&gt; CmpTestDep.m4</div>
<div class="line">CmpTemplateEmptyItf.m4 -&gt; CmpTestItf.m4</div>
<div class="line">CmpTemplateEmptyDep_m4.bat -&gt; CmpTestDep_m4.bat</div>
<div class="line">CmpTemplateEmptyItf_m4.bat -&gt; CmpTestItf_m4.bat</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Open the CmpTestItf_m4.bat file and replace the CmpTemplate
component name with the new component name. If you have changed the
directory structure, you have to adapt the path to the m4 build
utils in the *.bat files, too.</div>
<div class="line"><strong>Note:</strong> If you change the path to the “BuildUtils”, make sure to
be aware of the two different kind of slashes (‘/’ and ‘’) which
are used. If you are using absolute paths, you can use syntax like
this for the paths with the forward slashes:
d:/CODESYSSpV3/BuildUtils/…/…</div>
<div class="line"><strong>Note:</strong> The M4 tools need an empty directory named “etc” in
“BuildUtils/msys/etc”. If this doesn’t exist, you need to create
it.</div>
</div>
</li>
</ul>
<p>Now, execute the modified CmpTestItf.bat file. This will generate a
new, non-empty *Itf.h file. If there is now new *Itf.h file or the
file is empty, the component name or the path to the m4 build utils
is not correct.</p>
<ul>
<li><p>Do the same with the CmpTemplateDep_m4.bat file. If everything is
correct, you will get a new *Dep.h and a new *.cpp file. Both files
must not be empty.</p></li>
<li><p>Change the Component Information in *Dep.m4:</p>
<ol class="loweralpha">
<li><p>Set the new component name in the SET_COMPONENT_NAME macro.</p></li>
<li><p>Set the name of the c file in the COMPONENT_SOURCES macro. List
all c files separated with commas.</p></li>
<li><p>Set the component version in the COMPONENT_VERSION macro.</p></li>
<li><div class="line-block">
<div class="line">Set the component vendor ID.</div>
<div class="line"><strong>Note:</strong> Every vendor gets an ID from 3S. The value 0x0000 is
the 3S vendor Id and should not be used.</div>
</div>
</li>
<li><p>Rename and set the CMPID_ (component Id), CLASSID_ (class Id)
and ITFID_ (interface Id) of your new component.</p></li>
<li><p>Remove the category macro, it is not needed at the beginning.</p></li>
<li><div class="line-block">
<div class="line">Set the implemented interfaces in the IMPLEMENT_ITF macro.</div>
<div class="line">At the beginning the component will implement only its own
interface.</div>
</div>
</li>
<li><p>If your component uses the interface of another component, you
have to add the component in the USE_ITF list. Remove all unused
USE_ITF definitions. For more information, see the documentation
of the m4 mechanism.</p></li>
<li><p>In addition to the USE_ITF macro, you have to add every function,
which is used by your new component, to the REQUIRED_IMPORTS
macro. Remove all unused functions.</p></li>
</ol>
</li>
</ul>
<p>Our Example may now look like this:</p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span>/**
* &lt;name&gt;Component Template&lt;/name&gt;
* &lt;description&gt;
* An example on how to implement a component.
* This component does no useful work and it exports no functions
* which are intended to be used for anything. Use at your own risk.
* &lt;/description&gt;
* &lt;copyright&gt;
* (c) 2009 3S-Smart Software Solutions
* &lt;/copyright&gt;
*/
SET_COMPONENT_NAME(`CmpTest&#39;)
COMPONENT_SOURCES(`CmpTest.c&#39;)

COMPONENT_VERSION(`0x11223344&#39;)

/* NOTE: REPLACE 0x0000 BY YOUR VENDORID */
COMPONENT_VENDORID(`0x5678&#39;)

#define CMPID_CmpTest 0x2000
#define CLASSID_CCmpTest 0x2000
#define ITFID_ICmpTest 0x2000

CATEGORY(`Customer&#39;)

IMPLEMENT_ITF(`CmpTestItf.m4&#39;)

USE_ITF(`SysTimeItf.m4&#39;)

REQUIRED_IMPORTS(
SysTimeGetMs)
</pre></div>
</div>
<p>Open the *Itf.m4 file and set the interface name in the
SET_INTERFACE_NAME macro.
The *Itf.m4 file may look like this:</p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span>/**
* &lt;interfacename&gt;test&lt;/interfacename&gt;
* &lt;description&gt;&lt;/description&gt;
*
* &lt;copyright&gt;&lt;/copyright&gt;
*/
SET_INTERFACE_NAME(`CmpTest&#39;)

/** EXTERN LIB SECTION BEGIN **/
#ifdef __cplusplus
   extern &quot;C&quot; {
#endif

/**
* &lt;description&gt;myexternalfunction&lt;/description&gt;
*/
typedef struct tagmyexternalfunction_struct
{
   RTS_IEC_INT MyExternalFunction; /* VAR_OUTPUT */
} myexternalfunction_struct;

DEF_API(`void&#39;,`CDECL&#39;,`myexternalfunction&#39;,
`(myexternalfunction_struct*p)&#39;,1,0xE1C6D757,0x3040000)

#ifdef __cplusplus
}
#endif

/** EXTERN LIB SECTION END **/
</pre></div>
</div>
<p>Execute the *Dep_m4.bat and the *Itf_m4.bat to generate the new
header files. If you want to edit the header files afterwards, you
have to edit the m4 file and then you have to create the header
files using the bat files.</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>Never change the header files directly!</p></li>
<li><p>Always generate both header files! (even if you change only one of
them)</p></li>
</ol>
</div></blockquote>
<p>If you want to implement an external function (defined in an own
IEC Library), add it now to your C File (CmpTest.c). You can copy
the declaration from the header file *Itf.h.</p>
<p>For example:</p>
<blockquote>
<div><ol class="loweralpha">
<li><div class="line-block">
<div class="line">If you have the following Declaration in your M4 file (generated from CODESYS):</div>
</div>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span>DEF_API(`void&#39;,`CDECL&#39;,`myexternalfunction&#39;,
`(myexternalfunction_struct *p)&#39;,1,0xFFADC096,0x1000000)
</pre></div>
</div>
</li>
<li><div class="line-block">
<div class="line">Executing the corresponding batch file will create the following definition in your *Itf.h:</div>
</div>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="k">void</span> <span class="n">CDECL</span> <span class="n">CDECL_EXT</span> <span class="nf">myexternalfunction</span><span class="p">(</span><span class="n">myexternalfunction_struct</span> <span class="p">*</span><span class="n">p</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><div class="line-block">
<div class="line">Then you can create the following declaration in your C-File
(CmpTest.c):</div>
</div>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="k">void</span> <span class="n">CDECL</span> <span class="n">CDECL_EXT</span> <span class="nf">myexternalfunction</span><span class="p">(</span><span class="n">myexternalfunction_struct</span> <span class="p">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
   <span class="cm">/* function body */</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>When implementing the function, make sure you are using the CAL_
macros instead of calling functions of other components directly.
Add the newly references functions to the list of REQUIRED_IMPORTS
or OPTIONAL_IMPORTS, and add a section USE_ITF if a component is
references newly.</p></li>
</ol>
</div></blockquote>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="appendix_B.html" title="6.2.3.7. B: [Step by Step] Compiling a Component"
             >next</a> |</li>
        <li class="right" >
          <a href="create_io_driver_create_driver.html" title="Create an I/O Driver"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >6.2.3. Creating Runtime System Components, Libraries and I/O Drivers</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, 3S-Smart Software Solutions GmbH. This document is confidential. Unauthorized copying, disclosure or distribution of this document and the information contained herein is strictly forbidden.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>