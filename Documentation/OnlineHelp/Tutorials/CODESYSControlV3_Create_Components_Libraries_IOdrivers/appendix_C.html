

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>6.2.3.8. C: [Step by Step] Creating a new I/O Driver &#8212; RuntimeSystemDocumentation V3.5.16.40</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/theme.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6.3.1. CODESYS Control Scheduler" href="../CODESYSControlV3_Scheduler/index.html" />
    <link rel="prev" title="6.2.3.7. B: [Step by Step] Compiling a Component" href="appendix_B.html" /> 
  </head><body>
	<div id="header">
		<a href="#" title="CODESYS" target="_top" id="logo"><img src="../../_static/logo.png" width="134" height="130" alt=""></a>
		<a href="#" title="CODESYS Documentation" target="_top" id="logo-store"><img src="../../_static/logo2.png" width="137" height="130" alt=""></a>
	</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../CODESYSControlV3_Scheduler/index.html" title="6.3.1. CODESYS Control Scheduler"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="appendix_B.html" title="6.2.3.7. B: [Step by Step] Compiling a Component"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">6.2.3. Creating Runtime System Components, Libraries and I/O Drivers</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h4>Previous topic</h4>
  <p class="topless"><a href="appendix_B.html"
                        title="previous chapter">6.2.3.7. B: [Step by Step] Compiling a Component</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../CODESYSControlV3_Scheduler/index.html"
                        title="next chapter">6.3.1. CODESYS Control Scheduler</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="c-step-by-step-creating-a-new-i-o-driver">
<span id="tutorial-creating-components-libraries-iodrivers-appendix-c"></span><h1>6.2.3.8. C: [Step by Step] Creating a new I/O Driver<a class="headerlink" href="#c-step-by-step-creating-a-new-i-o-driver" title="Permalink to this headline">¶</a></h1>
<p>To create a new I/O driver, the IoDrvVerySimple component can be used as
a starting point. The IoDrvVerySimple is included in the runtime system
delivery.</p>
<p>To copy and rename the files, you can use the Python script
gen_cmp_from_temp.py or copy and rename them manually. To run the
script, you need Python installed. The steps are the same as for
creating a new component. See description above.</p>
<p>Notes:</p>
<ul>
<li><p>An I/O driver implementation will need some functions from other
components of the runtime system. Add those existing interfaces to
the *Dep.m4 file. For example:</p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span>IMPLEMENT_ITF(`CmpIoDrvItf.m4&#39;)

USE_ITF(`CmpIoMgrItf.m4&#39;)

REQUIRED_IMPORTS(
CMRegisterInstance,
IoMgrConfigGetParameter,
IoMgrConfigGetFirstConnector,
IoMgrConfigGetNextConnector,
IoMgrConfigGetFirstChild,
IoMgrConfigGetNextChild,
IoMgrConfigGetParameterValueWord,
IoMgrConfigSetDiagnosis,
IoMgrConfigResetDiagnosis,
IoMgrSetDriverProperties,
IoDrvCreate,
IoDrvDelete,
IoMgrCopyInputLE,
IoMgrCopyOutputLE)
</pre></div>
</div>
</li>
<li><p>These functions, included in the template, are needed to implement
the I/O Driver interface:</p>
<ol class="loweralpha simple">
<li><p>IoDrvCreate</p></li>
<li><p>IoDrvDelete</p></li>
<li><p>IoDrvGetInfo</p></li>
<li><p>IoUpdateConfiguration</p></li>
<li><p>IoDrvUpdateMapping</p></li>
<li><p>IoDrvReadInputs</p></li>
<li><p>IoDrvWriteOutputs</p></li>
<li><p>IoDrvStartBusCycle</p></li>
<li><p>IoDrvScanModules</p></li>
<li><p>IoDrvGetModuleDiagnosis</p></li>
<li><p>IoDrvIdentify</p></li>
<li><p>IoDrvWatchdogTrigger</p></li>
</ol>
</li>
</ul>
<p>Now, your component should compile without errors. In the current state
it won’t run, because we removed the assignment which made the link
between the driver and the physical I/O area. The purpose of this was,
that we want to support more than one I/O channel and therefore, we need
to make a link between every parameter and the corresponding address in
the I/O area.</p>
<p>In the next step, we want to create a device description, which
describes the I/O layout for the CODESYS programming system. The
templates contain examples of their device descriptions. What you
configure here, will be visible to</p>
<ul class="simple">
<li><p>your driver, through the download of the CODESYS application, and</p></li>
<li><p>the user when he opens the configuration editor for your device in
CODESYS.</p></li>
</ul>
<p>For our example we are using the following parameters:</p>
<ul class="simple">
<li><p>Vendor Name: 393218 (type: STRING)</p></li>
<li><p>Device Name: 393219 (type: STRING)</p></li>
<li><p>Inputs: 1000 - 1999 (type: DWORD)</p></li>
<li><p>Outputs: 2000 - 2999 (type: DWORD)</p></li>
</ul>
<p>As a starting point for the device description, it’s possible to use the
device description from the „IoDrvTemplate“, “IoDrvSimple” or
“IoDrvVerySimple. But in the end it shouldn’t contain more than two
connectors, one with the hostparameter set, defined above.</p>
<p>After this, we need to adapt our device driver to handle those new
parameters.</p>
<ul>
<li><p>Add a static array to simulate our I/O area:</p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MAX_CHANNELS 128</span>
<span class="cp">#define MAX_DRIVERS 1</span>
<span class="k">static</span> <span class="n">unsigned</span> <span class="kt">long</span> <span class="n">s_ulyIO</span><span class="p">[</span><span class="n">MAX_DRIVERS</span><span class="p">][</span><span class="n">MAX_CHANNELS</span><span class="p">];</span>
</pre></div>
</div>
</li>
</ul>
<p>In the code of the template, only one input and one output channel
are configured in IoDrvUpdateConfiguration(). Change this to
configure all channels, which are defined in the device
description. Save a direct pointer to the I/O area in the field
dwDriverSpecific of the parameters, corresponding to the channels.
For example:</p>
<blockquote>
<div><div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="cm">/* inputs */</span>
<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
   <span class="n">pParameter</span> <span class="p">=</span> <span class="n">CAL_IoMgrConfigGetParameter</span><span class="p">(</span><span class="n">pConnector</span><span class="p">,</span><span class="m">1000</span><span class="p">+</span><span class="n">i</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">pParameter</span> <span class="p">!=</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pParameter</span><span class="p">-&gt;</span><span class="n">dwDriverSpecific</span> <span class="p">=</span>
      <span class="p">(</span><span class="n">unsigned</span> <span class="kt">long</span><span class="p">)&amp;</span><span class="n">s_ulyIO</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">s_ulyIO</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">i</span><span class="p">+</span><span class="m">1</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">else</span>
      <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* outputs */</span>
<span class="k">for</span><span class="p">(</span><span class="cm">/* continue */</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
   <span class="n">pParameter</span> <span class="p">=</span> <span class="n">CAL_IoMgrConfigGetParameter</span><span class="p">(</span><span class="n">pConnector</span><span class="p">,</span><span class="m">2000</span><span class="p">+</span><span class="n">i</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">pParameter</span> <span class="p">!=</span> <span class="n">NULL</span><span class="p">)</span>
      <span class="n">pParameter</span><span class="p">-&gt;</span><span class="n">dwDriverSpecific</span> <span class="p">=</span>
      <span class="p">(</span><span class="n">unsigned</span> <span class="kt">long</span><span class="p">)&amp;</span><span class="n">s_ulyIO</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="k">else</span>
      <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>Change the „pbyDeviceAddress“ in IoDrvReadInputs() and
IoDrvWriteOutputs() from „pInfo-&gt;hSpecific“ to
„pConnectorMapList[i].pChannelMapList[j].pParameter-&gt;dwDriverSpecific“.
Because this is the value, where we saved our I/O address in
IoDrvUpdateConfiguration in the previous step.</p>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../CODESYSControlV3_Scheduler/index.html" title="6.3.1. CODESYS Control Scheduler"
             >next</a> |</li>
        <li class="right" >
          <a href="appendix_B.html" title="6.2.3.7. B: [Step by Step] Compiling a Component"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >6.2.3. Creating Runtime System Components, Libraries and I/O Drivers</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, 3S-Smart Software Solutions GmbH. This document is confidential. Unauthorized copying, disclosure or distribution of this document and the information contained herein is strictly forbidden.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>