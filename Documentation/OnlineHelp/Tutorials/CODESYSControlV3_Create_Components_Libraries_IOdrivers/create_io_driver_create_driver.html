

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Create an I/O Driver &#8212; RuntimeSystemDocumentation V3.5.16.40</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/theme.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6.2.3.6. A: [Step by Step] Creating a new Component" href="appendix_A.html" />
    <link rel="prev" title="Basic Concepts" href="create_io_driver_basic_concept.html" /> 
  </head><body>
	<div id="header">
		<a href="#" title="CODESYS" target="_top" id="logo"><img src="../../_static/logo.png" width="134" height="130" alt=""></a>
		<a href="#" title="CODESYS Documentation" target="_top" id="logo-store"><img src="../../_static/logo2.png" width="137" height="130" alt=""></a>
	</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="appendix_A.html" title="6.2.3.6. A: [Step by Step] Creating a new Component"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="create_io_driver_basic_concept.html" title="Basic Concepts"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >6.2.3. Creating Runtime System Components, Libraries and I/O Drivers</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="create_io_driver.html" accesskey="U">6.2.3.5. Create an I/O Driver in C</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h4>Previous topic</h4>
  <p class="topless"><a href="create_io_driver_basic_concept.html"
                        title="previous chapter">Basic Concepts</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="appendix_A.html"
                        title="next chapter">6.2.3.6. A: [Step by Step] Creating a new Component</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="create-an-i-o-driver">
<span id="create-io-driver-create-driver"></span><h1>Create an I/O Driver<a class="headerlink" href="#create-an-i-o-driver" title="Permalink to this headline">¶</a></h1>
<p>Please also look into CODESYSControlV3_Manual, chapter 10.3 Implementing
own components.</p>
<p>To create a new I/O driver, start with a template I/O driver component
provided in the runtime toolkit delivery. You can use these templates:</p>
<ul class="simple">
<li><p>IODrvTemplate: I/O driver template component</p></li>
<li><p>IODrvSimple: Quite simple I/O driver template component</p></li>
<li><p>IODrvVerySimple: Minimal I/O driver template component</p></li>
<li><p>IoDrvMasterTemplateIEC: Extensive example with</p>
<ul>
<li><p>I/O driver library written in IEC</p></li>
<li><p>Device descriptions with comments and explanations</p></li>
<li><p>Examples for diagnosis</p></li>
<li><p>Several types of submodules</p></li>
<li><p>Documentation in the library</p></li>
<li><p>Example project</p></li>
</ul>
</li>
<li><p>IoDrvSubModulesFix: Device description example with fixed submodules</p></li>
<li><p>IoDrvSubModulesVar: Device description example with var submodules</p></li>
<li><p>IoDrvSubModulesSlot: Device description example with slot submodules</p></li>
</ul>
<p>Copy the template and adjust the file names and component name. A Python
script (gen_cmp_from_temp.py) is provided that can help you with this
task. Adjust vendor id and version.</p>
<p>A step by step instruction is given in chapter “Appendix C: Step by
Step: Creating a new I/O Driver”.</p>
<p>The most important steps in an IODriver are:</p>
<div class="section" id="initialization">
<h2>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h2>
<p>At startup, an instance of the driver is created and registered at the
I/O manager. This is done in the HookFunction:</p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="k">case</span> <span class="n">CH_INIT2</span><span class="p">:</span>
<span class="p">{</span>
   <span class="n">RTS_HANDLE</span> <span class="n">hIoDrv</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
   <span class="k">void</span> <span class="p">*</span><span class="n">pTmp</span><span class="p">;</span>

   <span class="cm">/* first instance */</span>
   <span class="n">pTmp</span> <span class="p">=</span> <span class="n">CAL_IoDrvCreate</span><span class="p">(</span><span class="n">hIoDrv</span><span class="p">,</span> <span class="n">CLASSID_CIoDrvVerySimple</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
   <span class="n">s_pIBase</span> <span class="p">=</span> <span class="p">(</span><span class="n">IBase</span> <span class="p">*)</span><span class="n">pTmp</span><span class="p">;</span>
   <span class="n">CAL_IoMgrRegisterInstance</span><span class="p">(</span><span class="n">s_pIBase</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>

   <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>I/O driver interface function IoDrvCreate is called in this case.</p>
<p>From now on, the IOManager knows that our driver instance is available.
In this example we create one instance, but it is possible to create and
register more than one instances. This can be useful, e.g. when more
than one IO-device respectively fieldbuscard is available.</p>
</div>
<div class="section" id="download">
<h2>Download<a class="headerlink" href="#download" title="Permalink to this headline">¶</a></h2>
<p>At download, loading of a bootapplication or at reset of an application,
the I/O driver interface function IoDrvUpdateConfiguration is called.
You have to differentiate between two cases:</p>
<ul class="simple">
<li><p>The parameter pConnectorList is NULL: if an application was loaded
before and is removed before the new download starts.</p></li>
<li><p>The parameter pConnectorList is not NULL: then pConnectorList
contains the complete resource/connector tree as defined by the user,
including submodules, parameters and channels.</p></li>
</ul>
<p>I/O Manager helper functions can be used to read information from
pConnectorList, for example IoMgrConfigGetFirstConnector.</p>
<p>If a connector is found that our driver feels responsible for, it
registers in that connector. This is done in this line:</p>
<p>pConnector-&gt;hIoDrv = (RTS_IEC_HANDLE)pIBase;</p>
<p>From now on, the I/O Manager knows that our driver is responsible for
this connector.</p>
<p>The driver can read information about child connectors (with
IoMgrConfigGetFirstChild) and read parameter values (with
IoMgrConfigGetParameter).</p>
<p>The driver can also prepare for I/O update. The member dwDriverSpecific
of the IoConfigParameter structure can be used to store any information.
In our example, we store a pointer to global memory.</p>
<p>pParameter-&gt;dwDriverSpecific = (RTS_IEC_BYTE *)&amp;s_ulyInputs[i];</p>
<p>In real drivers, this memory could be refreshed by a low level driver to
update physical I/Os.</p>
<p>Our driver also write diagnostic information to the connector (with
IoMgrConfigSetDiagnosis). This information will be used by CODESYS in
online mode, to display the status of the modules in the device tree
(indicated by green circles or red triangles).</p>
<p>I/O driver interface function IoDrvUpdateMapping can be used to update
and optimize the mapping of channels.</p>
</div>
<div class="section" id="reading-inputs">
<h2>Reading Inputs<a class="headerlink" href="#reading-inputs" title="Permalink to this headline">¶</a></h2>
<p>I/O driver interface function IoDrvReadInputs is called at the beginning
of every IEC task. A list of all channels that need to be updated in
this task is passed, together with a list of used I/O modules. This
function shall copy the values of physical inputs to the IEC input area.
We are using I/O manager function IoMgrCopyInputLE to copy from the
physical to the logical memory.</p>
<p>Use IoMgrCopyInputBE if the physical memory is big endian.</p>
</div>
<div class="section" id="writing-outputs">
<h2>Writing Outputs<a class="headerlink" href="#writing-outputs" title="Permalink to this headline">¶</a></h2>
<p>Very similar to reading inputs. I/O driver interface function
IoDrvWriteOutputs is called at the end of every IEC task. A list of all
channels that need to be updated in this task is passed, together with a
list of used I/O modules. This function shall copy the values of the IEC
output area to physical outputs. We are using I/O manager
IoMgrCopyOutputLE to copy from the physical to the logical memory.</p>
<p>Use IoMgrCopyOutputBE if the physical memory is big endian.</p>
</div>
<div class="section" id="start-bus-cycle">
<h2>Start Bus Cycle<a class="headerlink" href="#start-bus-cycle" title="Permalink to this headline">¶</a></h2>
<p>I/O driver interface function IoDrvStartBusCycle is called in one
specific task, called the bus cycle task. This task can be specified by
the user. E.g.: Fieldbus drivers can send telegrams to the fieldbus
slaves here.</p>
</div>
<div class="section" id="scan-modules">
<h2>Scan Modules<a class="headerlink" href="#scan-modules" title="Permalink to this headline">¶</a></h2>
<p>I/O driver interface function IoDrvScanModules is called when the user
executes the command “Scan for devices”. The function has to fill the
ppConnectorList. It has to allocate the memory for this connectorlist.</p>
</div>
<div class="section" id="diagnosis">
<h2>Diagnosis<a class="headerlink" href="#diagnosis" title="Permalink to this headline">¶</a></h2>
<p>I/O driver interface function IoDrvGetModuleDiagnosis is called to set
diagnostic information. I/O manager function IoMgrConfigSetDiagnosis can
be used to set the diagnostic information to a connector.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="appendix_A.html" title="6.2.3.6. A: [Step by Step] Creating a new Component"
             >next</a> |</li>
        <li class="right" >
          <a href="create_io_driver_basic_concept.html" title="Basic Concepts"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >6.2.3. Creating Runtime System Components, Libraries and I/O Drivers</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="create_io_driver.html" >6.2.3.5. Create an I/O Driver in C</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, 3S-Smart Software Solutions GmbH. This document is confidential. Unauthorized copying, disclosure or distribution of this document and the information contained herein is strictly forbidden.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>