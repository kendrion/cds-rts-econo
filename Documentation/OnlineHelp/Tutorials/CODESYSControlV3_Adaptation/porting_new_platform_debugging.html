

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Debugging &#8212; RuntimeSystemDocumentation V3.5.16.40</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/theme.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6.2.2.3. Adding Features to the Runtime" href="adding_feature_to_runtime.html" />
    <link rel="prev" title="Testing the communication" href="porting_new_platform_testing.html" /> 
  </head><body>
	<div id="header">
		<a href="#" title="CODESYS" target="_top" id="logo"><img src="../../_static/logo.png" width="134" height="130" alt=""></a>
		<a href="#" title="CODESYS Documentation" target="_top" id="logo-store"><img src="../../_static/logo2.png" width="137" height="130" alt=""></a>
	</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="adding_feature_to_runtime.html" title="6.2.2.3. Adding Features to the Runtime"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="porting_new_platform_testing.html" title="Testing the communication"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >6.2.2. CODESYS Control V3 - Porting to a new platform</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="porting_new_platform.html" accesskey="U">6.2.2.2. Porting to a new Platform</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h4>Previous topic</h4>
  <p class="topless"><a href="porting_new_platform_testing.html"
                        title="previous chapter">Testing the communication</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="adding_feature_to_runtime.html"
                        title="next chapter">6.2.2.3. Adding Features to the Runtime</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="debugging">
<span id="porting-new-platform-debugging"></span><h1>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h1>
<div class="section" id="check-the-log-messages">
<h2>Check the log messages<a class="headerlink" href="#check-the-log-messages" title="Permalink to this headline">¶</a></h2>
<p>You should have the component CmpLogEmbedded in your runtime. This
component is used by other components as well as your IEC application to
collect all kinds of debug, info and error messages. There are three
ways to see those logs:</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>Logger page:</strong></div>
<div class="line">Double click on your device, switch to the “Log”-tab and press the
update button.</div>
<div class="line"><img alt="image17" src="../../_images/image17.jpeg" /></div>
<div class="line">Note, that this only works if your communication with the runtime
works.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Serial Terminal:</strong></div>
<div class="line">If you have a spare serial port, you can add and implement the
component “SysOut” to output the messages to your serial port.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Debugger:</strong></div>
<div class="line">If you don’t have a spare serial port nor a working communication,
you can use your debugger:</div>
<div class="line">Find out the address of the symbol “s_StdLogEntries” and add this
address to the memory window of your debugger. If you adjust the
number of displayed entries per line to LOG_MAX_INFO_LEN+20, you
can see a readable log, like this:</div>
<div class="line"><img alt="image18" src="../../_images/image18.jpeg" /></div>
</div>
</li>
</ul>
</div>
<div class="section" id="device-doesnt-appear-in-the-scan">
<h2>Device doesn’t appear in the scan<a class="headerlink" href="#device-doesnt-appear-in-the-scan" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Before we start debugging the problem. We should check our
configuration:</p>
<ul class="simple">
<li><p>Gateway.cfg (check the configuration of your COM port, as
described in 2.1.5.6.</p></li>
<li><p>Restart your Gateway (using the systray icon <img alt="image10" src="../../_images/image10.jpeg" />)
and check if it sends s.th. on the serial port when you press the
“Scan network” button. You can check the traffic with the tool
“portmon” from sysinternals.</p></li>
<li><p>Check your configuration in “sysdefines.h”. Check if you are using
the correct device and the correct baudrate.</p></li>
<li><p>Check if your driver supports the configured baudrate and if you
are using the correct serial port.</p></li>
</ul>
</li>
<li><p>Before we are debugging the driver on the Runtime side, we should
start monitoring the packets, which are sent over the bus. Please
start “portmon” from sysinternals, stop the CODESYS Gateway and
connect portmon to your serial port. After a restart of the Gateway
you should already see some packets on the bus. That means, that your
host is configured correctly.</p></li>
<li><p>If your serial driver is working (which we assume here), then it’s
only possible, that one of the components is not configured correctly
and discards the packet. In the case of a device scan, we are talking
directly to the component CmpDevice. So we should check with
breakpoints in various positions if the packet came through:</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>SysComMyPlat.c: SysComOpen()</strong></div>
<div class="line">Step through this function and check if the correct port is
opened and if you configured the hardware correctly.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>CmpRouter.c: HandleLocally()</strong></div>
<div class="line">Set a breakpoint into the „default“ branch and check in
s_protocolHandler[] if the handler, which we try to call is
registered there.</div>
<div class="line">If you see that the handler for the scan request is not
registered, you should check if CmpDevice is configured into
your runtime and if it is loaded correctly. If you can’t find
the reason in the configuration, you should try to debug through
the init code of CmpDevice. Just set a breakpoint into
CmpDevice.c: ComponentEntry() to see if the component is loaded
and configured.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>CmpDeviceSrv.c: DeviceServiceHandler()</strong>
If the scan request is already this far, everything looks fine
for the request and you will need to debug the response path.
There is no other way than stepping through the whole response
path and have a look on all error conditions. You need to find
out, why the request was accepted but the response was never sent.</div>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="unable-to-download-but-no-exception">
<h2>Unable to download but no exception<a class="headerlink" href="#unable-to-download-but-no-exception" title="Permalink to this headline">¶</a></h2>
<p>If you are using the CmpAppEmbedded and you are not able to login, you
most likely miss a setting in your device description to enable the
compact download, which is used by CmpAppEmbedded &gt;= V3.4.1.0. This is
an optimization, which is done for small embedded devices and changes
the download format.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;DeviceDescription&gt;</span>
<span class="nt">&lt;Device&gt;</span>
<span class="nt">&lt;ExtendedSettings&gt;</span>
<span class="nt">&lt;ts:TargetSettings&gt;</span>
<span class="nt">&lt;ts:section</span> <span class="na">name=</span><span class="s">”runtime_features”</span><span class="nt">&gt;</span>
<span class="nt">&lt;ts:setting</span> <span class="na">name=</span><span class="s">”compact_download”</span> <span class="na">type=</span><span class="s">”boolean”</span> <span class="na">access=</span><span class="s">”visible”</span>
<span class="na">xmlns:ts=</span><span class="s">”http://www.3s-software.com/schemas/TargetSettings-0.1.xsd”</span><span class="nt">&gt;&lt;ts:value&gt;</span>1<span class="nt">&lt;/ts:value&gt;&lt;/ts:setting&gt;</span>
</pre></div>
</div>
<p><strong>Note:</strong> This setting has no influence on the format of your
bootproject.</p>
</div>
<div class="section" id="exception-at-download">
<h2>Exception at download<a class="headerlink" href="#exception-at-download" title="Permalink to this headline">¶</a></h2>
<p>Your device already appears in the scan and you are able to perform a
login. For the first test, you should create an empty application and
try to download this.</p>
<p>When you log in for the first time you should get a pop up dialog that
informs you that no application is on the device and asks you if you
want to perform a download. If this doesn’t appear, your communication
is not working, yet and you should have a look into section 2.3.2.</p>
<p>If you get an exception at download, this exception will most likely
appear within our generated init code. But anyway this may have a few
different causes:</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>Compiler Settings:</strong></div>
<div class="line">First of all, you should double check your compiler settings in
your device descriptions. These should exactly match your device.
Take care about CPU, C-Compiler specific settings (only necessary
on some architectures), FPU.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Memory Layout:</strong></div>
<div class="line">Check that the areas that are allocated in SysMemMyPlat.c are
really free and correctly allocated. Check how they match to the
areas of your device description.</div>
<div class="line"><strong>Note:</strong> If you make an “update device” deleted areas may still
exist in your project. So please create a new project or add a new
PLC to your project if you changed the number of areas in your
device description!</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>SysCpuCallIECFuncWithParams</strong></div>
<div class="line">Check if your implementation of <em>SysCpuCallIECFuncWithParams()</em>
works as expected.</div>
</div>
</li>
</ul>
<p>To debug this problem, you should start in the function
<em>AppRunAfterDownloadCode()</em> of CmpApp or CmpAppEmbedded. Set a
breakpoint to this function and try to log in into your device. We
assume that you hit this breakpoint before the actual exception.</p>
<p>Step through this function and check where it crashes. Most likely it
will crash in one of the calls to SysCpuCallIECFuncWithParams. Depending
on that we have the following possible error causes:</p>
<ul>
<li><p>pfReloc:</p>
<ul>
<li><div class="line-block">
<div class="line"><em>SysCpuCallIECFuncWithParams()</em> crashes already when trying to
call the function pointer:</div>
<div class="line">On a 16 Bit platform you should check the width of the function
pointer. On all other systems you have most likely a wrong area
offset specified, or your implementation of
SysCpuCallIECFuncWithParams() is not working.</div>
</div>
</li>
<li><div class="line-block">
<div class="line">The call crashes somewhere in the IEC code:</div>
<div class="line">That means that the parameters which you passed to the function
over the stack, where not correct, that you have the wrong
compiler settings (FPU, Compiler Type, Architecture,…) or that
the memory area that you returned in <em>SysMemAllocArea()</em> was
wrong.</div>
</div>
</li>
<li><p>On architectures with segmented memory, you should check the
settings “code-segment-size” and “data-segment-size” in the
“memory-layout” of your device description.</p></li>
</ul>
</li>
<li><p>pfCodeInit</p></li>
<li><p>pfGlobalInit</p></li>
<li><p>pfDownloadPOU</p>
<ul class="simple">
<li><p>Check if this function is called and check if the function pointer
is valid.</p></li>
<li><p>This function is called over an indirection of the function call
table of our IEC application. So maybe there was already a fault
in pfGlobalInit where this table is setted up.</p></li>
</ul>
</li>
</ul>
<p>If you can’t find the issue by your own, you should send the following
information to your first level support contact at 3S – Smart Software
Solutions:</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>Call Stack:</strong></div>
<div class="line">At least you need to find out the position, where the exception
occurred. Also determine the kind of exception and maybe why it
occurred (e.g. TLB load exception because of a NULL pointer
access).</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Device Description:</strong></div>
<div class="line">You can send either your device description XML file or create a
project archive out of CODESYS.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Memory Layout:</strong></div>
<div class="line">Describe where your memory areas are allocated. It’s important to
know if you have fix addresses for your memory areas or if you
allocate them dynamically.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Code Snippets:</strong></div>
<div class="line">It will be much of help if you add your implementation of
SysCpuCallIECFuncWithParams() to your support request.</div>
</div>
</li>
</ul>
</div>
<div class="section" id="communication-timeout-after-a-few-seconds-minutes">
<h2>Communication Timeout after a few seconds/minutes<a class="headerlink" href="#communication-timeout-after-a-few-seconds-minutes" title="Permalink to this headline">¶</a></h2>
<p>The communication timeout is calculated based on the time returned by
SysTimeGetMs(). So when you get a timeout after some time, it is most
likely because of a wrong calculation there. A very common error would
be that you have too early wrap around in the timer value.</p>
<p>Abbroach to solve this:</p>
<ul>
<li><div class="line-block">
<div class="line">Temporarily set the implementation of SysTimeGetMs() to this:</div>
<div class="line">static unsigned long s_ulTimeMs;</div>
<div class="line">unsigned long CDECL SysTimeGetMs(void)</div>
<div class="line">{</div>
<div class="line">return s_ulTimeMs++;</div>
<div class="line">}</div>
</div>
</li>
<li><p>Try to implement SysTimeGetUs() correctly.</p></li>
<li><div class="line-block">
<div class="line">Create a small test project like this:</div>
</div>
<blockquote>
<div><div class="highlight-codesys notranslate"><div class="highlight"><pre><span></span>PROGRAM PLC_PRG
VAR
  us: SYSTIME;
  res: UDINT;
  last_us: ULINT;
  start_us: ULINT;
  error: BOOL;
END_VAR

res := SysTimeGetUs(pUsTime := start_us);
res := SysTimeGetUs(pUsTime := us);
WHILE (us – start_us) &lt; 500 DO
  res := SysTimeGetUs(pUsTime := us);
  IF us &lt; last_us THEN
    error := TRUE;
  END_IF
  last_us := us;
END_WHILE
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Verify your implementation of SysTimeGetUs() with the project above:</p>
<ul class="simple">
<li><p>The time, returned by SysTimeGetUs() should be continuously
growing until it wraps around at the boundary of the RTS_SYSTIME
datatype.</p></li>
<li><p>Check with an external clock if the time base of SysTimeGetUs() is
correct.</p></li>
</ul>
</li>
<li><p>Make SysTimeGetMs() behave similar to your SysTimeGetUs()
implementation.</p></li>
<li><p>Make sure that your intermediate values within your calculation don’t
exceed the boundary of the RTS_SYSTIME data type.</p></li>
</ul>
<p>Another error source is the serial block driver. This might have
problems with some combinations of buffer sizes. So check the following
definitions in <em>sysdefines.h</em>:</p>
<ul class="simple">
<li><p>BLKDRVCOM_MAX_SER_READSIZE: Maximum number of bytes that are read
with one call of SysComRead. Recommended values are 1..1024.</p></li>
<li><p>NETSERVER_BUFFERSIZE: Keep this value above 1024</p></li>
</ul>
</div>
<div class="section" id="other-errors">
<h2>Other Errors<a class="headerlink" href="#other-errors" title="Permalink to this headline">¶</a></h2>
<p>Here are a few things which you need to check if you couldn’t find a
hint for your problem in the sections above:</p>
<ul>
<li><div class="line-block">
<div class="line">Memory allocation at startup failed:</div>
<div class="line">Set a breakpoint in <em>SysMemAllocData()</em> and start the runtime
system. You should not hit this breakpoint. If you hit it anyway,
you should check why, and try to solve it.</div>
<div class="line">Known symptoms:</div>
</div>
<ul class="simple">
<li><p>Application download just hangs in keep-alive ping pongs and
doesn’t respond anymore.</p></li>
<li><p>The device doesn’t appear in the scan anymore.</p></li>
</ul>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="adding_feature_to_runtime.html" title="6.2.2.3. Adding Features to the Runtime"
             >next</a> |</li>
        <li class="right" >
          <a href="porting_new_platform_testing.html" title="Testing the communication"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >6.2.2. CODESYS Control V3 - Porting to a new platform</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="porting_new_platform.html" >6.2.2.2. Porting to a new Platform</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, 3S-Smart Software Solutions GmbH. This document is confidential. Unauthorized copying, disclosure or distribution of this document and the information contained herein is strictly forbidden.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>