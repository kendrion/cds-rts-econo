

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>CANMiniDriver Conformance Test (automatic test) &#8212; RuntimeSystemDocumentation V3.5.16.40</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/theme.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="CANEcho test (manual test)" href="conformance_test_canecho_test.html" />
    <link rel="prev" title="Overview" href="conformance_test_overview.html" /> 
  </head><body>
	<div id="header">
		<a href="#" title="CODESYS" target="_top" id="logo"><img src="../../_static/logo.png" width="134" height="130" alt=""></a>
		<a href="#" title="CODESYS Documentation" target="_top" id="logo-store"><img src="../../_static/logo2.png" width="137" height="130" alt=""></a>
	</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="conformance_test_canecho_test.html" title="CANEcho test (manual test)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="conformance_test_overview.html" title="Overview"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >6.3.8. CANMiniDriver for CODESYS V3</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="conformance_test.html" accesskey="U">6.3.8.4. Conformance Test</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h4>Previous topic</h4>
  <p class="topless"><a href="conformance_test_overview.html"
                        title="previous chapter">Overview</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="conformance_test_canecho_test.html"
                        title="next chapter">CANEcho test (manual test)</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="canminidriver-conformance-test-automatic-test">
<span id="conformance-test-canminidriver-test"></span><h1>CANMiniDriver Conformance Test (automatic test)<a class="headerlink" href="#canminidriver-conformance-test-automatic-test" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The CANMiniDriver Conformance Test consists of two applications: a test
server application that runs on the device under test (DUT) and a client
application designed for a CODESYS Control Win V3 with PCAN interface.</p>
<p><img alt="image21" src="../../_images/image21.png" /></p>
<p>Figure 21: Test setup</p>
<div class="line-block">
<div class="line">The test server is controlled by test control messages on CAN-ID 0
sent by the test client.</div>
<div class="line">The test server application performs the following tasks:</div>
</div>
<ul>
<li><div class="line-block">
<div class="line">It echoes all CAN messages with an incremented CAN-ID except of
following IDs:</div>
<div class="line">16#0 (Test Control message IDs)</div>
<div class="line">16#80-16#FF (CANopen Emergency IDs)</div>
<div class="line">16#580-16#67F (CANopen SDO IDs)</div>
<div class="line">Note: CAN IDs used for Blockdriver communication are not echoed.
Therefore, block driver communication can be used in parallel.</div>
</div>
</li>
<li><div class="line-block">
<div class="line">It checks the message data consistency: All received message must
have a sequence counter in the first byte (if DLC is greater 0).
The sequence counter is incremented with every message.</div>
<div class="line">All other bytes contain the incremented value of their predecessor.</div>
<div class="line">Example of a valid message sequence:</div>
<div class="line">ID 0x30, DLC=8: <strong>00</strong> 01 02 03 04 05 06 07</div>
<div class="line">ID 0x700, DLC=1: <strong>01</strong></div>
<div class="line">ID 0x703, DLC=0; (Sequence counter = 2)</div>
<div class="line">ID 0x20; DLC=3; <strong>03</strong> 04 05</div>
</div>
</li>
<li><p>It logs error information to the PLC logger.</p></li>
<li><p>It provides an integrated visualization with CAN Hardware
configuration settings and diagnostic information.</p></li>
</ul>
<p>The test client application performs the following tasks:</p>
<ul class="simple">
<li><p>It provides a visualization for test configuration.</p></li>
<li><p>It generates bus traffic over a PCAN interface and checks the echoed
messages received from the test device:</p>
<ul>
<li><p>Are the sequence counters in the correct order?</p></li>
<li><p>Is each message information echoed correctly (Data, DLC, RTR,
EID,…)?</p></li>
<li><p>Are all messages echoed? ( Tx count should be equal to Rx count).</p></li>
</ul>
</li>
<li><p>It shows the test result in the visualization.</p></li>
</ul>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>CODESYS 3.5 SP9 or higher</p></li>
<li><p>CODESYS Control Win V3 with Peak CAN interface (e.g. Peak PCAN USB
Dongle)</p></li>
<li><p>CMDConformanceTest project (included in runtime delivery:
Templates/CANMiniDriverConformanceTest)</p></li>
</ul>
</div>
<div class="section" id="test-procedure">
<h2>Test procedure<a class="headerlink" href="#test-procedure" title="Permalink to this headline">¶</a></h2>
<p>Open CMDConformance project
(Templates/CANMiniDriverConformanceTest/CMDConformanceTest.project) and
press “Update all” if Project Environment dialog opens.</p>
<div class="section" id="preparations-for-the-test-server">
<h3>Preparations for the test server<a class="headerlink" href="#preparations-for-the-test-server" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Update DeviceToTest Device to your PLC device description.</p></li>
<li><p>Download DeviceToTest.Application to your test device. Start the
application.</p></li>
<li><p>Open the integrated visualization ( double-click Visualization in the
device tree).</p>
<p><img alt="image22" src="../../_images/image22.png" /></p>
</li>
</ul>
<p>Figure 22: Test configuration</p>
<ul class="simple">
<li><p>Set the following settings:</p>
<ul>
<li><p>NetID of the CAN interface, e.g. 0</p></li>
<li><p>Baud rate (recommended: 1000)</p></li>
<li><p>Number of Tx Messages (recommended: 100)</p></li>
<li><p>29 bit CANID: Does your driver support 29-bit CANIDs (e.g. needed
for J1939)</p></li>
</ul>
</li>
<li><p>Switch on “Enable Testserver”</p>
<ul>
<li><p>The driver will be opened by calling CMD_Init and the
visualization shows all diagnostic counters.</p></li>
<li><p>If an error occurs (no diagnostic counters will be shown), then
check your test configuration. If NetID was correct, then check
the implementation of CMD_Setup (normally called in CH_INIT3 hook)
and CMD_Init (called on Cl2.DriverOpenH).</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="preparations-for-the-test-client">
<h3>Preparations for the test client<a class="headerlink" href="#preparations-for-the-test-client" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Install the PCAN USB interface driver and activate the
CmpPCANBasicDrv runtime system component in your CODESYS Control Win
V3 installation. For more information and detailed instructions, see
CODESYS Help topic “Inserting a PCAN USB adapter”.</p></li>
<li><p>Connect the PCAN interface to the test server (test setup see chapter
4.2.1).</p></li>
<li><p>Update Device “Tester” to the corresponding CODESYS Control Win V3
device.</p></li>
<li><p>Download Tester.Application to your CODESYS Control Win V3. Start the
application. The visualization opens:</p></li>
</ul>
<p><img alt="image23" src="../../_images/image23.png" /></p>
<p>Figure 23: Conformance Test</p>
</div>
<div class="section" id="automatic-test-execution">
<h3>Automatic test execution<a class="headerlink" href="#automatic-test-execution" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Setup the Test Client:</p>
<ul class="simple">
<li><p>Enter the NetID of PCAN interface (default: 0; see PLC logger).</p></li>
<li><p>Enter the same baud rate as configured on test server.</p></li>
<li><p>Enter maximal bus load (Recommended: 50-70%).</p></li>
<li><p>Enter “Echo test execution time” (default: 300 seconds).</p></li>
<li><p>Enter the test server cycle time (default: 20000us = 20 ms).</p></li>
<li><p>Select 29-bit CAN identifiers test if supported by MiniDriver.</p></li>
</ul>
</li>
<li><p>IF CODESYS communication over CAN is used on the same CAN Bus, then
it is recommended to log out from application to minimize bus
traffic.</p></li>
<li><p>Press Start Test</p>
<ul>
<li><p>The following tests are performed:</p>
<ul>
<li><div class="line-block">
<div class="line">Message Test:</div>
<div class="line">Different kind of messages are sent to the Test Server. It
will be checked if all information is echoed correctly.</div>
</div>
<ul class="simple">
<li><p>RTR messages</p></li>
<li><p>11-bit and 29-bit CANIDs</p></li>
<li><p>Different DLCs</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><div class="line-block">
<div class="line">Echo Test:</div>
<div class="line">The bus load is generated and echoed messages will be checked for
sequence and data errors. Furthermore, the message roundtrip time
is measured.</div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line">Errors will be shown in the error table of the visualization.
Additional information can also be found in the PLC log of the Test
Server and integrated visualization (diagnostic counters).</div>
<div class="line">If test was successful, then the green LED illuminates in the Result
Group Box.</div>
</div>
<div class="line-block">
<div class="line">If an error occurs in Message test, then the test prints the
corresponding CAN message in the error table.</div>
<div class="line">You can reproduce this error manually by sending this message with a
CAN Analyzer and checking the echoed message (CANID + 1, DLC, DATA,
RTR, 29 bit, …). The echoed message should be exactly the same message
but with an incremented CAN ID.</div>
<div class="line">If an error occurs in Echo Test, it is useful to record a CAN trace,
so you can analyze the message flow. CAN messages with CAN ID ending
on 0 (e.g. 0x890) are always sent by the tester. Messages with CAN ID
ending on 1 are sent by the tested device.</div>
</div>
</div>
<div class="section" id="bus-diagnostic-test">
<h3>Bus diagnostic test<a class="headerlink" href="#bus-diagnostic-test" title="Permalink to this headline">¶</a></h3>
<p>In addition to the automatic test, it is also required to test bus error
detection and BusOff recovery:</p>
<ul>
<li><p>Open the integrated visualization of DeviceToTest.</p></li>
<li><p>The group box “CL2 Diagnostics” shows all MiniDriver diagnostic
counters:</p>
<p><img alt="image24" src="../../_images/image24.png" /></p>
</li>
</ul>
<p>Figure 24: Bus Diagnostics</p>
<ul>
<li><p>The Bus State should be ERR_FREE and Bus Alarm FALSE.</p></li>
<li><p>Now start the test on Test Client side. Check following diagnostic
information:</p>
<ul class="simple">
<li><p>Tx Counter and Rx Counter are incremented.</p></li>
<li><p>Lost Counter is 0.</p></li>
<li><p>Tx Error and Rx Error Counter is 0.</p></li>
<li><p>Bus State remains ERR_FREE and Bus Alarm FALSE.</p></li>
</ul>
</li>
<li><p>Now generate a bus failure: Short circuit CAN Low and CAN High some
seconds:</p>
<p><img alt="image25" src="../../_images/image25.png" /></p>
</li>
</ul>
<p>Figure 25: CAN Sub-D</p>
<ul>
<li><div class="line-block">
<div class="line">The Bus State signals a bus error – normally bus off. In bus off
state, most CAN chips need a reset command. This will be signaled
by Bus Alarm = TRUE. As long as Bus Alarm is TRUE, no messages will
be sent or received (Tx an Rx Error Counter remain values).</div>
<div class="line">Now the application has to trigger a Reset Bus Alarm command which
leads to a CMD_ResetAlarm call. In this function, the MiniDriver
has to reset the chip.</div>
<div class="line">You can test this functionality by pressing the “Reset Bus Alarm”
button.</div>
<div class="line">Then check the following:</div>
</div>
<ul class="simple">
<li><p>Bus Alarm should change to FALSE.</p></li>
<li><p>Bus State is not equal to BUS_OFF.</p></li>
<li><p>RxCounter and TxCounter will be incremented again (if Test Client
sends still messages). Driver sends and receives messages again
Reset Bus Alarm implementation is correct.</p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="conformance_test_canecho_test.html" title="CANEcho test (manual test)"
             >next</a> |</li>
        <li class="right" >
          <a href="conformance_test_overview.html" title="Overview"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >6.3.8. CANMiniDriver for CODESYS V3</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="conformance_test.html" >6.3.8.4. Conformance Test</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, 3S-Smart Software Solutions GmbH. This document is confidential. Unauthorized copying, disclosure or distribution of this document and the information contained herein is strictly forbidden.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>