

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Optional Functions &#8212; RuntimeSystemDocumentation V3.5.16.40</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/theme.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Non-implemented functions" href="canminidriver_interface_nonimplemented_functions.html" />
    <link rel="prev" title="Required functions" href="canminidriver_interface_required_functions.html" /> 
  </head><body>
	<div id="header">
		<a href="#" title="CODESYS" target="_top" id="logo"><img src="../../_static/logo.png" width="134" height="130" alt=""></a>
		<a href="#" title="CODESYS Documentation" target="_top" id="logo-store"><img src="../../_static/logo2.png" width="137" height="130" alt=""></a>
	</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="canminidriver_interface_nonimplemented_functions.html" title="Non-implemented functions"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="canminidriver_interface_required_functions.html" title="Required functions"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >6.3.8. CANMiniDriver for CODESYS V3</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="canminidriver_interface.html" accesskey="U">6.3.8.2. CANMiniDriver interface</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h4>Previous topic</h4>
  <p class="topless"><a href="canminidriver_interface_required_functions.html"
                        title="previous chapter">Required functions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="canminidriver_interface_nonimplemented_functions.html"
                        title="next chapter">Non-implemented functions</a></p>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="optional-functions">
<span id="canminidriver-interface-optional-functions"></span><h1>Optional Functions<a class="headerlink" href="#optional-functions" title="Permalink to this headline">¶</a></h1>
<p>The following chapter describes all optional functions of a
CANMiniDriver.</p>
<div class="section" id="diagnosis">
<h2>Diagnosis<a class="headerlink" href="#diagnosis" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">Bus diagnosis is an optional functionality. In general, a driver will
also work without implementing it. But it is highly recommended to
implement it. With diagnosis information about the CAN bus, a CAN
application (e.g. CANopen stack) can react to bus errors and give
diagnosis feedback to the user.</div>
<div class="line">If a driver registers at CL2, then a pointer to a CL2I_Info structure
is returned. This structure contains diagnosis counters and other
diagnosis information, such as bus state.</div>
</div>
<p><img alt="image13" src="../../_images/image13.png" /></p>
<p>Figure 13: Diagnosis structure</p>
<div class="section" id="diagnostic-counter">
<h3>Diagnostic Counter<a class="headerlink" href="#diagnostic-counter" title="Permalink to this headline">¶</a></h3>
<p>The following diagnostic counters are defined (see also Figure 13:
Diagnosis structure):</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>ctMessagesSend:</strong></div>
<div class="line">should be incremented when a message was successfully sent.</div>
<div class="line">Should be set to 0 when driver will be disposed.</div>
<div class="line">For drivers with Tx IRQ: Increment it in TX IRQ handler;</div>
<div class="line">For drivers without IRQ: Increment it in CMD_Send</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>ctMessagesReceived:</strong></div>
<div class="line">Should be incremented when a message was successfully received and passed to CL2 by calling MsgPutRQueue.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>ctRxErrors:</strong></div>
<div class="line">Should be set to the value of the CAN chip’s Rx Error register.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>ctTxErrors:</strong></div>
<div class="line">Should be set to the value of the CAN chip’s Tx Error register.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>ctDataOverruns:</strong></div>
<div class="line">Number of dismissed receive messages.</div>
<div class="line">Should be incremented when message was received by chip, but no
message handle could be allocated and if the chip signals a data
overrun situation (if supported).</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>usiBusLoad:</strong></div>
<div class="line">Current bus load in percent.</div>
<div class="line">Currently not implemented on drivers provided by CODESYS.</div>
</div>
</li>
</ul>
</div>
<div class="section" id="bus-state">
<h3>Bus State<a class="headerlink" href="#bus-state" title="Permalink to this headline">¶</a></h3>
<p>Another very important component of the CL2I_INFO structure is the
variable byBusState. It holds the current state of the associated
CANbus. The following values can be set by the CANMiniDriver
implementation:</p>
<p><img alt="image14" src="../../_images/image14.png" /></p>
<p>Figure 14: Bus State</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>UNKNOWN</strong></div>
<div class="line">The state of the network is not known or the bus state is not
implemented by driver.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>ERR_FREE</strong></div>
<div class="line">No occurrence of CANbus errors so far. The error counters of the
chip are zero.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>ACTIVE</strong></div>
<div class="line">Only a few CANbus errors so far. The error counters of the chip
are below the warning level.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>WARNING</strong></div>
<div class="line">Occurrence of some CANbus errors. The error counters are above
the warning level.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>PASSIVE</strong></div>
<div class="line">Too many CANbus errors. The error counters are above the error
level.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>BUSOFF</strong></div>
<div class="line">The node has been separated from the CANbus. The error counter has
exceeded the permitted maximum.</div>
</div>
</li>
</ul>
</div>
<div class="section" id="cmd-resetalarm-bus-alarm-handling">
<h3>CMD_ResetAlarm: Bus Alarm Handling<a class="headerlink" href="#cmd-resetalarm-bus-alarm-handling" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">A CANMiniDriver should detect bus alarm events such as Bus Off. A bus
alarm is an error situation which cannot be resolved without
reinitializing the chip. A CANMiniDriver signals a bus alarm to the
higher software layers by incrementing uiBusAlarm variable of
CL2I_INFO structure. An application calls CL2.GetBusAlarm which
returns the result of the Boolean expression: uiBusAlarm &gt; 0.</div>
<div class="line">An application can try to fix the bus alarm by calling
CL2.ResetBusAlarm which leads to a call of CMD_ResetAlarm. The
CANMiniDriver should initialize the CAN chip to normal operating mode.
If a bus alarm is fixed, then uiBusAlarm should be set to 0 by
CANMiniDriver.</div>
<div class="line">Note:</div>
</div>
<ul>
<li><p>A CANopenStack calls ResetAlarm each bus cycle as long as GetBusAlarm
returns true. This has to be considered when implementing ResetAlarm.</p></li>
<li><div class="line-block">
<div class="line">If a CANMiniDriver supports the detection of bus alarms and
CMD_ResetAlarm is implemented, then set CMD_SUPPORT_BUSALARM flag
in CMD_GetInfo.</div>
<div class="line">Otherwise, CMD_ResetAlarm has to return CMD_NOT_IMPLEMENTED.</div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line">Example:</div>
<div class="line">This is an example of a driver without IRQ. There are many different
ways to implement bus alarm handling. This is just one of many
possible solutions.</div>
</div>
<div class="highlight-C# notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">CAA_ERROR</span> <span class="nf">CMD_ResetAlarm</span><span class="p">(</span><span class="n">CL2I_BYTE</span> <span class="n">byNet</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">CAA_BYTE</span> <span class="n">byDriver</span> <span class="p">=</span> <span class="n">s_byDriver</span><span class="p">[</span><span class="n">byNet</span><span class="p">];</span>
  <span class="n">CL2I_INFO</span><span class="p">*</span> <span class="n">pInfo</span> <span class="p">=</span> <span class="n">s_pInfo</span><span class="p">[</span><span class="n">byDriver</span><span class="p">];</span>
  <span class="n">XXX_INFO</span> <span class="n">pDriver</span> <span class="p">=</span> <span class="p">&amp;</span><span class="n">xxxDriverContext</span><span class="p">[</span><span class="n">byDriver</span><span class="p">]</span>

  <span class="k">if</span> <span class="p">(!</span><span class="n">pInfo</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">CMD_SETUP_ERROR</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="cm">/* This driver */</span>
  <span class="n">xxxDriverContext</span><span class="p">[</span><span class="n">byDriver</span><span class="p">].</span><span class="n">reset_current</span> <span class="p">=</span> <span class="n">CAL_SysTimeGetMs</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pDriver</span><span class="p">-&gt;</span><span class="n">reset_last</span> <span class="p">!=</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">pDriver</span><span class="p">-&gt;</span><span class="n">reset_current</span> <span class="p">-</span> <span class="n">pDriver</span><span class="p">-&gt;</span><span class="n">reset_last</span><span class="p">)</span> <span class="p">&lt;</span> <span class="m">1000</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">CMD_NO_ERROR</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="p">-&gt;</span><span class="n">uiBusAlarm</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">pDriver</span><span class="p">-&gt;</span><span class="n">reset_last</span> <span class="p">=</span> <span class="n">pDriver</span><span class="p">-&gt;</span><span class="n">reset_current</span><span class="p">;</span>
    <span class="cm">/* This is just an example for getting a driver into normal operating mode */</span>
    <span class="n">CMD_Dispose</span><span class="p">(</span><span class="n">byNet</span><span class="p">);</span>
    <span class="n">CMD_Init</span><span class="p">(</span><span class="n">byNet</span><span class="p">,</span> <span class="n">pDriver</span><span class="p">-&gt;</span><span class="n">wBaudrate</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">    For drivers without IRQ: Empty Tx Queue after bus alarm.</span>
<span class="cm">    For IRQ driver: Call MsgSendAcknIRQ in IRQ Handler when bus error is fixed.</span>
<span class="cm">    */</span>
    <span class="n">CAL_CL2_MsgSendAcknNoIRQ</span><span class="p">(</span><span class="n">byNet</span><span class="p">,</span> <span class="n">CAA_hINVALID</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">pInfo</span><span class="p">-&gt;</span><span class="n">uiBusAlarm</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">CMD_NO_ERROR</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="cmd-setstatus-leds">
<h3>CMD_SetStatus: LEDs<a class="headerlink" href="#cmd-setstatus-leds" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">A CANMiniDriver may implement LEDs according to CiA 303-3 indicator
specification. This can be signaled in CMD_GetInfo by setting the
CMD_SUPPORT_STATUSLED flag.</div>
<div class="line">If CL2 detects a LED state change, then CL2 calls CMD_SetStatus:</div>
</div>
<div class="line-block">
<div class="line"><img alt="image15" src="../../_images/image15.png" /></div>
<div class="line">byIndicator contains information for two LEDs:</div>
</div>
<p><img alt="image16" src="../../_images/image16.png" /></p>
<p>Figure 16: LED flags</p>
</div>
</div>
<div class="section" id="cmd-setblock-cmd-setcycle">
<h2>CMD_SetBlock, CMD_SetCycle<a class="headerlink" href="#cmd-setblock-cmd-setcycle" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">A CANMiniDriver may support the cyclic sending of CAN messages.
Therefore, CL2 provides two functions: one for setting a specific
transmit message handle (SetBlock) and one for activating cyclic
sending for this handle (SetCycle). These two function calls are
redirected to the corresponding CANMiniDriver implementation.</div>
<div class="line">This feature can be used for CANopenStack to get a better jitter for
Sync messages (see the next section).</div>
<div class="line">If a CANMiniDriver supports this function, then CMD_GetInfo has to
return the CMD_SUPPORT_SETCYCLE flag and the number of supported
messages (for byMaxCycleIndex, see also 2.1.1).</div>
</div>
<p><img alt="image17" src="../../_images/image17.png" /></p>
<div class="line-block">
<div class="line"><strong>byIndex:</strong> It is possible to register several transmit messages.
They are identified by an index starting with 0.</div>
<div class="line"><strong>hBlock:</strong> The message handle.</div>
<div class="line"><strong>peError:</strong> Optional pointer to an error enumeration. Return
CMD_NOT_IMPLEMENTED if function is not supported.</div>
</div>
<p><img alt="image18" src="../../_images/image18.png" /></p>
<div class="line-block">
<div class="line"><strong>byIndex:</strong> Index of message</div>
<div class="line"><strong>dwCycle:</strong> cycle time for message in microseconds.</div>
</div>
<p>Return CMD_NOT_IMPLEMENTED if function is not supported.</p>
<div class="section" id="usage-of-cmd-setblock-cmd-setcycle-for-canopen-sync-messages">
<h3>Usage of CMD_SetBlock, CMD_SetCycle for CANopen Sync messages<a class="headerlink" href="#usage-of-cmd-setblock-cmd-setcycle-for-canopen-sync-messages" title="Permalink to this headline">¶</a></h3>
<p>By default, CANopen Sync messages are sent cyclically from the IEC bus
cycle task. This means that, under poor circumstances, the CANopen Sync
messages will have a jitter that is equal to the jitter of this
cyclically called task.</p>
<p>In order to generate a more accurate sync signal, it is possible to
generate those packets externally from a hardware timer and to trigger
the CAN task from this timer.</p>
<p><img alt="image19" src="../../_images/image19.png" /></p>
<p>Figure 19: External Sync Overview</p>
<p>When sync is enabled in a CANopen project, the 3S CANopen stack attempts
to enable the external sync mechanism of the CAN driver. This will be
successful if the driver implements the following two functions of the
CAN L2 driver API:</p>
<ul class="simple">
<li><p>CMD_SetBlock()</p></li>
<li><p>CMD_SetCycle()</p></li>
</ul>
<p>The function CMD_SetBlock() is called to pass the sync message to the
driver. CMD_SetBlock() receives a block handle from a message block that
contains the sync message. This function takes control of the passed
block handle. This control is given back to the calling function at the
next call of CMD_SetBlock().</p>
<p>The function CMD_SetCycle() is called by CL2 to define the cycle time in
which a sync packet will be generated. This time value is given in
microseconds and should be used to program a hardware timer.</p>
<p>Within the timer ISR, the CAN driver needs to send the packet to the
CAN. After a send interrupt has signaled that the sync packet was sent,
the driver needs to send an event to the motion task.</p>
<p><img alt="image20" src="../../_images/image20.png" /></p>
<p>Figure 20: Timer ISR</p>
<p><strong>CAN Timer ISR example:</strong></p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="n">s_pClonedSyncBlock</span> <span class="p">=</span> <span class="n">CAL_CL2_MsgClone</span><span class="p">(</span> <span class="n">CanNet</span><span class="p">,</span> <span class="n">pSavedSyncBlock</span><span class="p">,&amp;</span><span class="n">error</span> <span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="n">error</span> <span class="p">==</span> <span class="n">CL2_NO_ERROR</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">CMD_Send</span><span class="p">(</span> <span class="n">CanNet</span><span class="p">,</span> <span class="n">s_pClonedSyncBlock</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>CAN Send ISR:</strong></p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">s_pSyncBlockCloned</span> <span class="p">==</span> <span class="n">hBlock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* Wake up the Motion Task */</span>
  <span class="k">if</span><span class="p">((</span><span class="n">s_hEventCanSync</span> <span class="p">!=</span> <span class="n">RTS_INVALID_HANDLE</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">CAL_SysEventSet</span><span class="p">(</span><span class="n">s_hEventCanSync</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>When you are using a target with external sync, you are creating a
motion task which is triggered by an external event. But this also means
that you will not define a cycle time for this task. This time will be
implicitly defined with the external sync period.</p>
<p>However, because the SoftMotion stack needs to know the cycle time of
the task on which it is running, you need to set this time within your
CAN driver manually. This can be done directly in the function
CMD_SetCycle() because you get the sync period in this function.</p>
<p>To get the task handle of the motion task, as well as the sync event,
you need to register on the event “TaskCreateDone” of “CmpSchedule”. You
should search for your event name and save a handle to this event, as
well as to the task handle, in a static variable of the driver.</p>
<p><strong>Example of CMD_SetCycle():</strong></p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="cm">/* set cycle time of IEC task */</span>

<span class="k">if</span><span class="p">(</span><span class="n">s_hTaskCanSyncInfo</span> <span class="p">!=</span> <span class="n">NULL</span><span class="p">)</span>

<span class="n">s_hTaskCanSyncInfo</span><span class="p">-&gt;</span><span class="n">tInterval</span> <span class="p">=</span> <span class="n">dwCycle</span><span class="p">;</span>

<span class="cm">/* program hardware timer */</span>

<span class="cm">/* xxx */</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="canminidriver_interface_nonimplemented_functions.html" title="Non-implemented functions"
             >next</a> |</li>
        <li class="right" >
          <a href="canminidriver_interface_required_functions.html" title="Required functions"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RuntimeSystemDocumentation V3.5.16.40</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >6. Tutorials / HowTos</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >6.3.8. CANMiniDriver for CODESYS V3</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="canminidriver_interface.html" >6.3.8.2. CANMiniDriver interface</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, 3S-Smart Software Solutions GmbH. This document is confidential. Unauthorized copying, disclosure or distribution of this document and the information contained herein is strictly forbidden.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>